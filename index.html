<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANSYS AEC Trend Analysis</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-card: #fbfbfd;
            --accent-danger: #ff3b30;
            --accent-warning: #ff9500;
            --accent-success: #34c759;
            --accent-info: #007aff;
            --accent-purple: #af52de;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --border: #d2d2d7;
            --glow-danger: rgba(255, 59, 48, 0.15);
            --glow-warning: rgba(255, 149, 0, 0.15);
            --glow-success: rgba(52, 199, 89, 0.15);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.47059;
            font-weight: 400;
            letter-spacing: -0.022em;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
        }

        .bg-grid {
            display: none;
        }

        header {
            position: relative;
            z-index: 1;
            margin-bottom: 50px;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
            letter-spacing: -0.015em;
            line-height: 1.05;
        }

        .subtitle {
            font-size: 1.0625rem;
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        .upload-grid {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 40px;
            animation: fadeIn 1s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 32px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: var(--shadow-sm);
        }

        .upload-section:hover {
            border-color: var(--accent-info);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .upload-section.dragover {
            border-color: var(--accent-success);
            background: rgba(52, 199, 89, 0.03);
            transform: scale(1.01);
        }

        .upload-section.loaded {
            border-color: var(--accent-success);
            background: rgba(52, 199, 89, 0.03);
        }

        .upload-section h3 {
            font-size: 1.375rem;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .upload-label {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-info);
            color: white;
            border-radius: 12px;
            font-size: 0.6875rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            margin-bottom: 12px;
        }

        .upload-label.historical {
            background: var(--accent-purple);
        }

        input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: var(--accent-info);
            color: white;
            border: none;
            padding: 12px 28px;
            font-size: 1.0625rem;
            font-weight: 500;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .upload-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .upload-btn:active {
            transform: scale(0.98);
        }

        .upload-btn.historical {
            background: var(--accent-purple);
        }

        .upload-btn.historical:hover {
            box-shadow: 0 4px 12px rgba(175, 82, 222, 0.3);
        }

        .file-status {
            margin-top: 16px;
            font-size: 0.9375rem;
            min-height: 20px;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        .settings-section {
            position: relative;
            z-index: 1;
            background: var(--bg-card);
            border-radius: 18px;
            padding: 40px;
            margin-bottom: 40px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            animation: fadeIn 1s ease-out 0.4s both;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .setting-item label {
            display: block;
            font-size: 0.9375rem;
            font-weight: 500;
            letter-spacing: -0.01em;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .setting-item input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 1.0625rem;
            font-weight: 400;
            letter-spacing: -0.01em;
            transition: all 0.2s ease;
        }

        .setting-item input:focus {
            outline: none;
            border-color: var(--accent-info);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .stats-grid {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
            animation: fadeIn 1s ease-out 0.6s both;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 32px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .stat-card::before {
            display: none;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-info);
        }

        .stat-label {
            font-size: 0.9375rem;
            font-weight: 500;
            letter-spacing: -0.01em;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .stat-subtext {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .trend-indicator.up {
            background: rgba(220, 38, 38, 0.15);
            color: var(--accent-danger);
        }

        .trend-indicator.down {
            background: rgba(5, 150, 105, 0.15);
            color: var(--accent-success);
        }

        .trend-indicator.stable {
            background: rgba(100, 116, 139, 0.15);
            color: var(--text-secondary);
        }

        .section-title {
            font-size: 2.125rem;
            font-weight: 600;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.015em;
        }

        .comparison-section {
            position: relative;
            z-index: 1;
            margin-bottom: 40px;
            animation: fadeIn 1s ease-out 0.8s both;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .comparison-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 32px;
            box-shadow: var(--shadow-sm);
        }

        .comparison-card h3 {
            font-size: 1.5rem;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .period-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8125rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .period-badge.historical {
            background: rgba(175, 82, 222, 0.12);
            color: var(--accent-purple);
        }

        .period-badge.recent {
            background: rgba(0, 122, 255, 0.12);
            color: var(--accent-info);
        }

        .alerts-section {
            position: relative;
            z-index: 1;
            margin-bottom: 40px;
            animation: fadeIn 1s ease-out 1s both;
        }

        .alert-card {
            background: var(--bg-card);
            border-left: 3px solid var(--accent-danger);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .alert-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .alert-card.critical {
            animation: alertPulse 2s ease-in-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% { box-shadow: 0 0 20px var(--glow-danger); }
            50% { box-shadow: 0 0 40px var(--glow-danger); }
        }

        .alert-card.warning {
            border-left-color: var(--accent-warning);
            animation: warningPulse 2s ease-in-out infinite;
        }

        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 20px var(--glow-warning); }
            50% { box-shadow: 0 0 40px var(--glow-warning); }
        }

        .alert-card.accelerating {
            border-left-color: var(--accent-purple);
            animation: accelPulse 2s ease-in-out infinite;
        }

        @keyframes accelPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.3); }
            50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.3); }
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .alert-user {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .alert-badge {
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.8125rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .alert-badge.critical {
            background: var(--accent-danger);
            color: white;
        }

        .alert-badge.high {
            background: var(--accent-warning);
            color: white;
        }

        .alert-badge.accelerating {
            background: var(--accent-purple);
            color: white;
        }

        .alert-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .alert-metric {
            font-size: 0.9375rem;
        }

        .alert-metric-label {
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        .alert-metric-value {
            font-weight: 600;
            font-size: 1.25rem;
            margin-top: 4px;
            letter-spacing: -0.015em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9375rem;
        }

        th {
            text-align: left;
            padding: 16px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: -0.01em;
            font-size: 0.8125rem;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }

        tr:hover td {
            background: var(--bg-secondary);
        }

        .usage-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 8px;
        }

        .usage-bar-fill {
            height: 100%;
            background: var(--accent-info);
            transition: width 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 6px;
        }

        .usage-bar-fill.high {
            background: var(--accent-danger);
        }

        .purchase-section {
            position: relative;
            z-index: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 48px;
            text-align: center;
            animation: fadeIn 1s ease-out 1.2s both;
            box-shadow: var(--shadow-md);
        }

        .purchase-btn {
            background: var(--accent-info);
            color: white;
            border: none;
            padding: 16px 48px;
            font-size: 1.0625rem;
            font-weight: 500;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
            letter-spacing: -0.01em;
        }

        .purchase-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
        }

        .purchase-btn:active {
            transform: scale(0.98);
        }

        .hidden {
            display: none;
        }

        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @media (max-width: 1024px) {
            .upload-grid,
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <div class="dashboard-container">
        <header>
            <h1>ANSYS AEC Trend Analysis</h1>
            <p class="subtitle">Historical vs Recent Usage Comparison</p>
        </header>

        <div class="upload-grid">
            <div class="upload-section" id="historicalUploadSection">
                <span class="upload-label historical">Historical Data</span>
                <h3>Last Year Usage</h3>
                <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.85rem;">
                    Upload CSV with full year of historical data
                </p>
                <input type="file" id="historicalFile" accept=".csv">
                <button class="upload-btn historical" onclick="document.getElementById('historicalFile').click()">
                    Choose Historical CSV
                </button>
                <p id="historicalStatus" class="file-status"></p>
            </div>

            <div class="upload-section" id="recentUploadSection">
                <span class="upload-label">Recent Data</span>
                <h3>Last Week Usage</h3>
                <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.85rem;">
                    Upload CSV with most recent week of data
                </p>
                <input type="file" id="recentFile" accept=".csv">
                <button class="upload-btn" onclick="document.getElementById('recentFile').click()">
                    Choose Recent CSV
                </button>
                <p id="recentStatus" class="file-status"></p>
            </div>
        </div>

        <div class="settings-section">
            <h2 class="section-title">Alert Settings</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <label>Available Balance (AEC)</label>
                    <input type="number" id="availableBalance" value="5000" min="0">
                </div>
                <div class="setting-item">
                    <label>Procurement Lead Time (weeks)</label>
                    <input type="number" id="leadTimeWeeks" value="2" min="0" step="0.5">
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">Time required to receive new credits</p>
                </div>
                <div class="setting-item">
                    <label>Purchase Order Amount (AEC)</label>
                    <input type="number" id="purchaseAmount" value="5000" min="0">
                </div>
                <div class="setting-item">
                    <label>Acceleration Alert (%)</label>
                    <input type="number" id="accelThreshold" value="50" min="0">
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">Alert if recent usage is X% higher than average</p>
                </div>
            </div>
            <div id="calculatedThresholds" style="margin-top: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
                <h3 style="font-size: 1.1rem; margin-bottom: 12px; color: var(--text-primary);">üìä Calculated Thresholds</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;">Critical Weekly Rate</div>
                        <div id="criticalWeeklyRate" style="font-size: 1.4rem; font-weight: 600; color: var(--accent-danger); margin-top: 4px;">-</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">Users above this need immediate attention</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;">Warning Weekly Rate</div>
                        <div id="warningWeeklyRate" style="font-size: 1.4rem; font-weight: 600; color: var(--accent-warning); margin-top: 4px;">-</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">Buffer zone - monitor closely</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;">Safe Weekly Rate</div>
                        <div id="safeWeeklyRate" style="font-size: 1.4rem; font-weight: 600; color: var(--accent-success); margin-top: 4px;">-</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">Sustainable consumption level</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardContent" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Historical Avg/Month</div>
                    <div class="stat-value" id="historicalAvg" style="color: var(--accent-purple);">0</div>
                    <div class="stat-subtext">AEC per month (yearly avg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Recent Weekly Usage</div>
                    <div class="stat-value" id="recentWeekly" style="color: var(--accent-info);">0</div>
                    <div class="stat-subtext">AEC in last week</div>
                    <div id="weeklyTrend"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Projected Monthly</div>
                    <div class="stat-value" id="projectedMonthly" style="color: var(--accent-warning);">0</div>
                    <div class="stat-subtext">Based on recent pace</div>
                    <div id="projectionTrend"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Balance Runway</div>
                    <div class="stat-value" id="runwayMonths" style="color: var(--accent-success);">0</div>
                    <div class="stat-subtext">months remaining</div>
                </div>
            </div>

            <div class="alerts-section">
                <h2 class="section-title">
                    <span>‚ö° Usage Alerts</span>
                </h2>
                <div id="alertsList"></div>
            </div>

            <div class="comparison-section">
                <h2 class="section-title">User Comparison</h2>
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <h3>
                            <span class="period-badge historical">Historical</span>
                            Average Usage
                        </h3>
                        <div id="historicalUserTable"></div>
                    </div>
                    <div class="comparison-card">
                        <h3>
                            <span class="period-badge recent">Recent Week</span>
                            Current Usage
                        </h3>
                        <div id="recentUserTable"></div>
                    </div>
                </div>
            </div>

            <div class="purchase-section" id="purchaseSection">
                <h2 style="margin-bottom: 16px; font-size: 2rem;">Running Low on Credits?</h2>
                <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 1.1rem;">
                    Current balance: <strong id="balanceWarning" style="color: var(--accent-warning);">0 AEC</strong><br>
                    Projected depletion: <strong id="depletionWarning" style="color: var(--accent-danger);"></strong><br>
                    <span id="depletionWeeks" style="font-size: 0.95rem;"></span>
                </p>
                <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                    <button class="purchase-btn pulse" onclick="requestPurchase()">
                        Request More AECs
                    </button>
                    <button class="purchase-btn" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-info)); box-shadow: 0 4px 16px rgba(147, 51, 234, 0.3);" onclick="exportToTeams()">
                        Update the Team
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let historicalData = [];
        let recentData = [];
        let settings = {
            leadTimeWeeks: 2,
            accelThreshold: 50,
            availableBalance: 5000,
            purchaseAmount: 5000
        };
        let calculatedThresholds = {
            criticalWeekly: 0,
            warningWeekly: 0,
            safeWeekly: 0
        };

        // File upload handlers
        document.getElementById('historicalFile').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0], 'historical');
        });

        document.getElementById('recentFile').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0], 'recent');
        });

        // Drag and drop
        setupDragDrop('historicalUploadSection', 'historicalFile');
        setupDragDrop('recentUploadSection', 'recentFile');

        function setupDragDrop(sectionId, fileInputId) {
            const section = document.getElementById(sectionId);
            section.addEventListener('dragover', (e) => {
                e.preventDefault();
                section.classList.add('dragover');
            });
            section.addEventListener('dragleave', () => {
                section.classList.remove('dragover');
            });
            section.addEventListener('drop', (e) => {
                e.preventDefault();
                section.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    document.getElementById(fileInputId).files = e.dataTransfer.files;
                    handleFileUpload(file, fileInputId === 'historicalFile' ? 'historical' : 'recent');
                }
            });
        }

        // Settings change handlers
        ['leadTimeWeeks', 'accelThreshold', 'availableBalance', 'purchaseAmount'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                settings[id] = parseFloat(this.value);
                if (historicalData.length > 0 && recentData.length > 0) {
                    updateDashboard();
                }
            });
        });

        function handleFileUpload(file, type) {
            if (!file) return;
            
            const statusId = type === 'historical' ? 'historicalStatus' : 'recentStatus';
            const sectionId = type === 'historical' ? 'historicalUploadSection' : 'recentUploadSection';
            
            document.getElementById(statusId).innerHTML = `<span style="color: var(--accent-info);">Loading: ${file.name}</span>`;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = parseCSV(event.target.result);
                
                if (type === 'historical') {
                    historicalData = data;
                } else {
                    recentData = data;
                }
                
                document.getElementById(statusId).innerHTML = `<span style="color: var(--accent-success);">‚úì Loaded: ${file.name}</span>`;
                document.getElementById(sectionId).classList.add('loaded');
                
                if (historicalData.length > 0 && recentData.length > 0) {
                    setTimeout(() => {
                        document.getElementById('dashboardContent').classList.remove('hidden');
                        updateDashboard();
                    }, 300);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const row = {};
                headers.forEach((header, i) => {
                    row[header] = values[i] ? values[i].trim() : '';
                });
                return row;
            });
        }

        function updateDashboard() {
            // Calculate recent metrics first
            const recentTotal = recentData.reduce((sum, row) => sum + parseFloat(row['Cost'] || 0), 0);
            const totalUsers = new Set(recentData.map(row => row['Username'])).size;
            
            // Calculate dynamic thresholds based on burn rate and lead time
            // Critical: If we continue at this rate, will we run out before new credits arrive?
            // We need enough buffer for lead time + some safety margin
            const leadTimeBuffer = settings.leadTimeWeeks * 1.5; // 1.5x safety factor
            const warningBuffer = settings.leadTimeWeeks * 2; // 2x for early warning
            const safeBuffer = settings.leadTimeWeeks * 3; // 3x for comfortable operation
            
            // Calculate weekly rates based on available balance
            calculatedThresholds.criticalWeekly = settings.availableBalance / leadTimeBuffer;
            calculatedThresholds.warningWeekly = settings.availableBalance / warningBuffer;
            calculatedThresholds.safeWeekly = settings.availableBalance / safeBuffer;
            
            // Update threshold display
            document.getElementById('criticalWeeklyRate').textContent = `${calculatedThresholds.criticalWeekly.toFixed(1)} AEC/week`;
            document.getElementById('warningWeeklyRate').textContent = `${calculatedThresholds.warningWeekly.toFixed(1)} AEC/week`;
            document.getElementById('safeWeeklyRate').textContent = `${calculatedThresholds.safeWeekly.toFixed(1)} AEC/week`;
            
            // Calculate historical metrics
            const historicalByMonth = {};
            historicalData.forEach(row => {
                const startTime = row['Start Time'];
                if (startTime) {
                    const month = startTime.substring(0, 7);
                    const cost = parseFloat(row['Cost'] || 0);
                    historicalByMonth[month] = (historicalByMonth[month] || 0) + cost;
                }
            });

            const historicalMonthlyValues = Object.values(historicalByMonth);
            const historicalAvgMonthly = historicalMonthlyValues.length > 0 
                ? historicalMonthlyValues.reduce((a, b) => a + b, 0) / historicalMonthlyValues.length 
                : 0;

            const projectedMonthly = recentTotal * 4.33; // weeks to month conversion

            // Calculate runway
            const runwayWeeks = recentTotal > 0 ? settings.availableBalance / recentTotal : 999;
            const runwayMonths = runwayWeeks / 4.33;

            // Update stats
            document.getElementById('historicalAvg').textContent = historicalAvgMonthly.toFixed(1);
            document.getElementById('recentWeekly').textContent = recentTotal.toFixed(1);
            document.getElementById('projectedMonthly').textContent = projectedMonthly.toFixed(1);
            document.getElementById('runwayMonths').textContent = runwayMonths.toFixed(1);

            // Add trend indicators
            const weeklyChange = ((projectedMonthly - historicalAvgMonthly) / historicalAvgMonthly) * 100;
            const weeklyTrendHTML = getTrendHTML(weeklyChange);
            document.getElementById('weeklyTrend').innerHTML = weeklyTrendHTML;
            document.getElementById('projectionTrend').innerHTML = weeklyTrendHTML;

            // Add burn rate status
            let burnRateStatus = '';
            if (recentTotal > calculatedThresholds.criticalWeekly) {
                burnRateStatus = '<div class="trend-indicator up" style="margin-top: 8px;">üî• Critical burn rate</div>';
            } else if (recentTotal > calculatedThresholds.warningWeekly) {
                burnRateStatus = '<div class="trend-indicator" style="margin-top: 8px; background: rgba(234, 88, 12, 0.15); color: var(--accent-warning);">‚ö†Ô∏è Elevated burn rate</div>';
            } else {
                burnRateStatus = '<div class="trend-indicator down" style="margin-top: 8px;">‚úì Sustainable rate</div>';
            }
            document.getElementById('weeklyTrend').innerHTML += burnRateStatus;

            // Calculate user metrics
            const historicalByUser = calculateUserMetrics(historicalData);
            const recentByUser = calculateUserMetrics(recentData);

            // Generate alerts with dynamic thresholds
            const alerts = generateAlerts(historicalByUser, recentByUser, historicalAvgMonthly, projectedMonthly);
            renderAlerts(alerts);

            // Render comparison tables
            renderUserComparison(historicalByUser, recentByUser);

            // Update purchase section
            const currentBalance = settings.availableBalance;
            document.getElementById('balanceWarning').textContent = `${currentBalance.toFixed(1)} AEC`;
            
            if (runwayMonths < 12) {
                const today = new Date();
                const depletionDate = new Date(today.getTime() + (runwayMonths * 30.44 * 24 * 60 * 60 * 1000));
                document.getElementById('depletionWarning').textContent = `~${depletionDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;
                
                // Add weeks display
                const weeksText = runwayWeeks < 1 
                    ? `(‚ö†Ô∏è Less than 1 week remaining!)` 
                    : `(~${runwayWeeks.toFixed(1)} weeks remaining)`;
                document.getElementById('depletionWeeks').innerHTML = weeksText;
                document.getElementById('depletionWeeks').style.color = runwayWeeks <= settings.leadTimeWeeks 
                    ? 'var(--accent-danger)' 
                    : runwayWeeks <= settings.leadTimeWeeks * 2 
                    ? 'var(--accent-warning)' 
                    : 'var(--text-secondary)';
            } else {
                document.getElementById('depletionWarning').textContent = '12+ months';
                document.getElementById('depletionWeeks').innerHTML = '(52+ weeks remaining)';
                document.getElementById('depletionWeeks').style.color = 'var(--accent-success)';
            }

            // Show purchase section if we're in warning or critical zone
            if (recentTotal > calculatedThresholds.warningWeekly || runwayWeeks <= settings.leadTimeWeeks * 2) {
                document.getElementById('purchaseSection').style.display = 'block';
            }
        }

        function getTrendHTML(changePercent) {
            if (Math.abs(changePercent) < 10) {
                return `<span class="trend-indicator stable">‚âà ${Math.abs(changePercent).toFixed(0)}% stable</span>`;
            } else if (changePercent > 0) {
                return `<span class="trend-indicator up">‚Üë ${changePercent.toFixed(0)}% higher</span>`;
            } else {
                return `<span class="trend-indicator down">‚Üì ${Math.abs(changePercent).toFixed(0)}% lower</span>`;
            }
        }

        function calculateUserMetrics(data) {
            const userByMonth = {};
            
            data.forEach(row => {
                const user = row['Username'];
                const startTime = row['Start Time'];
                if (user && startTime) {
                    if (!userByMonth[user]) {
                        userByMonth[user] = {};
                    }
                    const month = startTime.substring(0, 7);
                    const cost = parseFloat(row['Cost'] || 0);
                    userByMonth[user][month] = (userByMonth[user][month] || 0) + cost;
                }
            });

            const userMetrics = {};
            Object.keys(userByMonth).forEach(user => {
                const monthlyValues = Object.values(userByMonth[user]);
                const total = monthlyValues.reduce((a, b) => a + b, 0);
                const avg = total / monthlyValues.length;
                const max = Math.max(...monthlyValues);
                
                userMetrics[user] = {
                    total,
                    avgMonthly: avg,
                    maxMonthly: max,
                    months: monthlyValues.length
                };
            });

            return userMetrics;
        }

        function generateAlerts(historicalByUser, recentByUser, historicalAvgMonthly, projectedMonthly) {
            const alerts = [];

            // Check each user in recent data
            Object.keys(recentByUser).forEach(user => {
                const recentWeekly = recentByUser[user].total;
                const recentProjected = recentWeekly * 4.33;
                
                const historical = historicalByUser[user];
                
                if (!historical) {
                    // New user - check against critical weekly threshold
                    if (recentWeekly >= calculatedThresholds.criticalWeekly) {
                        alerts.push({
                            user,
                            level: 'critical',
                            type: 'new-critical',
                            recentWeekly,
                            recentProjected,
                            historicalAvg: 0,
                            change: 999,
                            reason: `New user consuming ${recentWeekly.toFixed(1)} AEC/week (critical threshold: ${calculatedThresholds.criticalWeekly.toFixed(1)} AEC/week)`
                        });
                    } else if (recentWeekly >= calculatedThresholds.warningWeekly) {
                        alerts.push({
                            user,
                            level: 'high',
                            type: 'new-warning',
                            recentWeekly,
                            recentProjected,
                            historicalAvg: 0,
                            change: 999,
                            reason: `New user with elevated usage: ${recentWeekly.toFixed(1)} AEC/week`
                        });
                    }
                } else {
                    const historicalAvg = historical.avgMonthly;
                    const historicalWeekly = historicalAvg / 4.33;
                    const change = ((recentWeekly - historicalWeekly) / historicalWeekly) * 100;
                    
                    // Critical: User's weekly rate exceeds critical threshold
                    if (recentWeekly >= calculatedThresholds.criticalWeekly) {
                        alerts.push({
                            user,
                            level: 'critical',
                            type: 'burn-rate',
                            recentWeekly,
                            recentProjected,
                            historicalAvg,
                            change,
                            reason: `Weekly rate ${recentWeekly.toFixed(1)} AEC exceeds critical threshold ${calculatedThresholds.criticalWeekly.toFixed(1)} AEC. At this rate, balance depletes before new credits arrive.`
                        });
                    }
                    // Warning: User's weekly rate exceeds warning threshold
                    else if (recentWeekly >= calculatedThresholds.warningWeekly) {
                        alerts.push({
                            user,
                            level: 'high',
                            type: 'burn-rate',
                            recentWeekly,
                            recentProjected,
                            historicalAvg,
                            change,
                            reason: `Weekly rate ${recentWeekly.toFixed(1)} AEC exceeds warning threshold ${calculatedThresholds.warningWeekly.toFixed(1)} AEC`
                        });
                    }
                    // Acceleration alert: Usage increased significantly vs historical
                    else if (change >= settings.accelThreshold) {
                        alerts.push({
                            user,
                            level: 'accelerating',
                            type: 'acceleration',
                            recentWeekly,
                            recentProjected,
                            historicalAvg,
                            change,
                            reason: `Usage accelerating: ${change.toFixed(0)}% above historical average`
                        });
                    }
                }
            });

            return alerts.sort((a, b) => {
                const levelOrder = { critical: 0, high: 1, accelerating: 2 };
                return levelOrder[a.level] - levelOrder[b.level];
            });
        }

        function renderAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">‚úì No alerts. All users are within safe consumption rates.</p>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => {
                const description = alert.reason || 'Usage requires attention';

                return `
                    <div class="alert-card ${alert.level}">
                        <div class="alert-header">
                            <div class="alert-user">${alert.user}</div>
                            <div class="alert-badge ${alert.level}">${alert.level}</div>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5;">${description}</p>
                        <div class="alert-details">
                            <div class="alert-metric">
                                <div class="alert-metric-label">Recent Week</div>
                                <div class="alert-metric-value" style="color: var(--accent-info);">${alert.recentWeekly.toFixed(1)} AEC</div>
                            </div>
                            <div class="alert-metric">
                                <div class="alert-metric-label">Projected/Month</div>
                                <div class="alert-metric-value" style="color: var(--accent-danger);">${alert.recentProjected.toFixed(1)} AEC</div>
                            </div>
                            <div class="alert-metric">
                                <div class="alert-metric-label">Historical Avg</div>
                                <div class="alert-metric-value" style="color: var(--accent-purple);">${alert.historicalAvg.toFixed(1)} AEC</div>
                            </div>
                            <div class="alert-metric">
                                <div class="alert-metric-label">Change</div>
                                <div class="alert-metric-value" style="color: ${alert.change > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'};">
                                    ${alert.change > 0 ? '+' : ''}${alert.change === 999 ? 'NEW' : alert.change.toFixed(0) + '%'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUserComparison(historicalByUser, recentByUser) {
            // Historical table
            const historicalUsers = Object.entries(historicalByUser)
                .sort((a, b) => b[1].avgMonthly - a[1].avgMonthly)
                .slice(0, 10);

            const historicalHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th style="text-align: right;">Avg/Month</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${historicalUsers.map(([user, metrics]) => `
                            <tr>
                                <td style="font-weight: 600;">${user}</td>
                                <td style="text-align: right; font-weight: 600; color: var(--accent-purple);">${metrics.avgMonthly.toFixed(1)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('historicalUserTable').innerHTML = historicalHTML;

            // Recent table with comparison
            const recentUsers = Object.entries(recentByUser)
                .map(([user, metrics]) => {
                    const historical = historicalByUser[user];
                    const projected = metrics.total * 4.33;
                    const change = historical 
                        ? ((projected - historical.avgMonthly) / historical.avgMonthly) * 100
                        : 999;
                    
                    return { user, projected, change };
                })
                .sort((a, b) => b.projected - a.projected)
                .slice(0, 10);

            const recentHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th style="text-align: right;">Projected/Month</th>
                            <th style="text-align: right;">vs Avg</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentUsers.map(({user, projected, change}) => `
                            <tr>
                                <td style="font-weight: 600;">${user}</td>
                                <td style="text-align: right; font-weight: 600; color: var(--accent-info);">${projected.toFixed(1)} AEC</td>
                                <td style="text-align: right; font-weight: 600; color: ${change > 20 ? 'var(--accent-danger)' : change < -20 ? 'var(--accent-success)' : 'var(--text-secondary)'};">
                                    ${change === 999 ? 'NEW' : (change > 0 ? '+' : '') + change.toFixed(0) + '%'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('recentUserTable').innerHTML = recentHTML;
        }

        function requestPurchase() {
            const recentWeekly = parseFloat(document.getElementById('recentWeekly').textContent);
            const runway = parseFloat(document.getElementById('runwayMonths').textContent);
            const runwayWeeks = runway * 4.33;

            const subject = encodeURIComponent('ANSYS AEC Purchase Request');
            const body = encodeURIComponent(
                `Hello,\n\nOur burn rate has been ${recentWeekly.toFixed(1)} AEC/week, with a prediction that these credits will last us ${runwayWeeks.toFixed(1)} weeks. Can you assist in putting in an order for ${settings.purchaseAmount.toFixed(0)} AECs?\n\nBest,\nNatacha`
            );

            // Open Outlook with pre-filled email
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        function exportToTeams() {
            const historicalAvg = parseFloat(document.getElementById('historicalAvg').textContent);
            const recentWeekly = parseFloat(document.getElementById('recentWeekly').textContent);
            const projectedMonthly = parseFloat(document.getElementById('projectedMonthly').textContent);
            const currentBalance = parseFloat(document.getElementById('balanceWarning').textContent);
            const runway = parseFloat(document.getElementById('runwayMonths').textContent);
            const runwayWeeks = runway * 4.33;
            const alertCount = document.querySelectorAll('.alert-card').length;

            // Determine status emoji
            let statusEmoji = '‚úÖ';
            let statusText = 'Good';
            if (recentWeekly > calculatedThresholds.criticalWeekly) {
                statusEmoji = 'üî¥';
                statusText = 'Critical';
            } else if (recentWeekly > calculatedThresholds.warningWeekly) {
                statusEmoji = 'üü°';
                statusText = 'Warning';
            } else if (runwayWeeks <= settings.leadTimeWeeks * 2) {
                statusEmoji = 'üü†';
                statusText = 'Monitor';
            }

            // Get top 3 users from alerts or recent usage
            const alerts = Array.from(document.querySelectorAll('.alert-card')).slice(0, 3);
            let topUsersText = '';
            if (alerts.length > 0) {
                topUsersText = '\n\nHIGH USAGE USERS:\n';
                alerts.forEach(alert => {
                    const userName = alert.querySelector('.alert-user').textContent;
                    const level = alert.querySelector('.alert-badge').textContent;
                    topUsersText += `  ‚Ä¢ ${userName} (${level})\n`;
                });
            }

            const message = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n` +
                `ANSYS AEC USAGE STATUS UPDATE ${statusEmoji}\n` +
                `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
                `OVERALL STATUS: ${statusText}\n\n` +
                `CURRENT METRICS:\n` +
                `  ‚Ä¢ Current Balance: ${currentBalance.toFixed(1)} AEC\n` +
                `  ‚Ä¢ Burn Rate: ${recentWeekly.toFixed(1)} AEC/week\n` +
                `  ‚Ä¢ Projected Monthly: ${projectedMonthly.toFixed(1)} AEC/month\n` +
                `  ‚Ä¢ Historical Average: ${historicalAvg.toFixed(1)} AEC/month\n` +
                `  ‚Ä¢ Trend: ${projectedMonthly > historicalAvg ? '‚Üë' : '‚Üì'} ${Math.abs(((projectedMonthly - historicalAvg) / historicalAvg) * 100).toFixed(0)}%\n\n` +
                `RUNWAY:\n` +
                `  ‚Ä¢ Time Remaining: ${runwayWeeks.toFixed(1)} weeks (${runway.toFixed(1)} months)\n` +
                `  ‚Ä¢ Projected Depletion: ${document.getElementById('depletionWarning').textContent}\n\n` +
                `THRESHOLDS:\n` +
                `  ‚Ä¢ Critical Rate: ${calculatedThresholds.criticalWeekly.toFixed(1)} AEC/week\n` +
                `  ‚Ä¢ Warning Rate: ${calculatedThresholds.warningWeekly.toFixed(1)} AEC/week\n` +
                `  ‚Ä¢ Safe Rate: ${calculatedThresholds.safeWeekly.toFixed(1)} AEC/week${topUsersText}\n\n` +
                `${alertCount > 0 ? `‚ö†Ô∏è  ${alertCount} user(s) flagged for high usage\n\n` : ''}` +
                `Updated: ${new Date().toLocaleString()}\n` +
                `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

            // Copy to clipboard
            navigator.clipboard.writeText(message).then(() => {
                alert('‚úÖ Status update copied to clipboard!\n\nYou can now paste this into your Teams channel.');
            }).catch(() => {
                // Fallback if clipboard fails
                const textarea = document.createElement('textarea');
                textarea.value = message;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úÖ Status update copied to clipboard!\n\nYou can now paste this into your Teams channel.');
            });
        }
    </script>
</body>
</html>
