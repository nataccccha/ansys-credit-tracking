<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANSYS AEC Trend Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-card: #fbfbfd;
            --accent-danger: #ff3b30;
            --accent-warning: #ff9500;
            --accent-success: #34c759;
            --accent-info: #007aff;
            --accent-teal: #005B7F;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --border: #d2d2d7;
            --glow-danger: rgba(255, 59, 48, 0.15);
            --glow-warning: rgba(255, 149, 0, 0.15);
            --glow-success: rgba(52, 199, 89, 0.15);
            --glow-teal: rgba(0, 91, 127, 0.15);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-card: #2c2c2e;
            --accent-danger: #ff453a;
            --accent-warning: #ff9f0a;
            --accent-success: #32d74b;
            --accent-info: #0a84ff;
            --accent-teal: #0088AA;
            --text-primary: #f5f5f7;
            --text-secondary: #98989d;
            --border: #38383a;
            --glow-danger: rgba(255, 69, 58, 0.3);
            --glow-warning: rgba(255, 159, 10, 0.3);
            --glow-success: rgba(50, 215, 75, 0.3);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.47059;
            font-weight: 400;
            letter-spacing: -0.022em;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
        }

        .bg-grid {
            display: none;
        }

        header {
            position: relative;
            z-index: 1;
            margin-bottom: 20px;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            letter-spacing: -0.015em;
            line-height: 1.05;
        }

        .subtitle {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        .upload-grid {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
            animation: fadeIn 1s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: var(--shadow-sm);
        }

        .upload-section:hover {
            border-color: var(--accent-info);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .upload-section.dragover {
            border-color: var(--accent-success);
            background: rgba(52, 199, 89, 0.03);
            transform: scale(1.01);
        }

        .upload-section.loaded {
            border-color: var(--accent-success);
            background: rgba(52, 199, 89, 0.03);
        }

        .upload-section h3 {
            font-size: 0.875rem;
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .upload-label {
            display: inline-block;
            padding: 2px 8px;
            background: var(--accent-info);
            color: white;
            border-radius: 8px;
            font-size: 0.625rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            margin-bottom: 6px;
        }

        .upload-label.historical {
            background: var(--accent-teal);
        }

        input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: var(--accent-info);
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 0.9375rem;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .upload-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .upload-btn:active {
            transform: scale(0.98);
        }

        .upload-btn.historical {
            background: var(--accent-teal);
        }

        .upload-btn.historical:hover {
            box-shadow: 0 4px 12px rgba(175, 82, 222, 0.3);
        }

        .file-status {
            margin-top: 10px;
            font-size: 0.8125rem;
            min-height: 20px;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        .settings-section {
            position: relative;
            z-index: 1;
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            animation: fadeIn 1s ease-out 0.4s both;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .setting-item label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: -0.01em;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .setting-item input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 400;
            letter-spacing: -0.01em;
            transition: all 0.2s ease;
        }

        .setting-item input:focus {
            outline: none;
            border-color: var(--accent-info);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .stats-grid {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
            animation: fadeIn 1s ease-out 0.6s both;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: var(--shadow-sm);
            text-align: center;
            min-width: 0;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-info);
        }

        .stat-label {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            margin-bottom: 2px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 2px;
            letter-spacing: -0.02em;
        }

        .stat-subtext {
            font-size: 0.625rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.5625rem;
            font-weight: 600;
            margin-top: 2px;
        }

        .trend-indicator.up {
            background: rgba(220, 38, 38, 0.15);
            color: var(--accent-danger);
        }

        .trend-indicator.down {
            background: rgba(5, 150, 105, 0.15);
            color: var(--accent-success);
        }

        .trend-indicator.stable {
            background: rgba(100, 116, 139, 0.15);
            color: var(--text-secondary);
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            letter-spacing: -0.015em;
        }

        /* Sidebar Navigation for Usage Analysis */
        .sidebar-layout {
            display: flex;
            gap: 16px;
            min-height: 400px;
        }

        .sidebar-nav {
            width: 180px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sidebar-nav-item {
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-nav-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .sidebar-nav-item.active {
            background: var(--accent-info);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .sidebar-content {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid var(--border);
            overflow: auto;
        }

        .sidebar-panel {
            display: none;
        }

        .sidebar-panel.active {
            display: block;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .comparison-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
        }

        .comparison-card h3 {
            font-size: 0.875rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .period-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.6875rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .period-badge.historical {
            background: rgba(175, 82, 222, 0.12);
            color: var(--accent-teal);
        }

        .period-badge.recent {
            background: rgba(0, 122, 255, 0.12);
            color: var(--accent-info);
        }

        .alert-card {
            background: var(--bg-card);
            border-left: 3px solid var(--accent-danger);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 8px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .alert-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .alert-card.critical {
            animation: alertPulse 2s ease-in-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% { box-shadow: 0 0 20px var(--glow-danger); }
            50% { box-shadow: 0 0 40px var(--glow-danger); }
        }

        .alert-card.warning {
            border-left-color: var(--accent-warning);
            animation: warningPulse 2s ease-in-out infinite;
        }

        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 20px var(--glow-warning); }
            50% { box-shadow: 0 0 40px var(--glow-warning); }
        }

        .alert-card.accelerating {
            border-left-color: var(--accent-teal);
            animation: accelPulse 2s ease-in-out infinite;
        }

        @keyframes accelPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.3); }
            50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.3); }
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .alert-user {
            font-size: 0.9375rem;
            font-weight: 600;
        }

        .alert-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.6875rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .alert-badge.critical {
            background: var(--accent-danger);
            color: white;
        }

        .alert-badge.high {
            background: var(--accent-warning);
            color: white;
        }

        .alert-badge.accelerating {
            background: var(--accent-teal);
            color: white;
        }

        .alert-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .alert-metric {
            font-size: 0.8125rem;
        }

        .alert-metric-label {
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: -0.01em;
            font-size: 0.8125rem;
        }

        .alert-metric-value {
            font-weight: 600;
            font-size: 0.8125rem;
            margin-top: 3px;
            letter-spacing: -0.015em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9375rem;
        }

        th {
            text-align: left;
            padding: 16px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: -0.01em;
            font-size: 0.8125rem;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }

        tr:hover td {
            background: var(--bg-secondary);
        }

        .usage-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 8px;
        }

        .usage-bar-fill {
            height: 100%;
            background: var(--accent-info);
            transition: width 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 6px;
        }

        .usage-bar-fill.high {
            background: var(--accent-danger);
        }

        .purchase-section {
            position: relative;
            z-index: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            animation: fadeIn 1s ease-out 1.2s both;
            box-shadow: var(--shadow-md);
        }

        .purchase-btn {
            background: var(--accent-info);
            color: white;
            border: none;
            padding: 10px 24px;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
            letter-spacing: -0.01em;
        }

        .purchase-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
        }

        .purchase-btn:active {
            transform: scale(0.98);
        }

        .hidden {
            display: none;
        }

        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .dark-mode-toggle:hover {
            box-shadow: var(--shadow-md);
            transform: scale(1.05);
        }

        /* Active Users Box */
        .active-users-box {
            position: absolute;
            top: 20px;
            right: 140px;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 20px;
            box-shadow: var(--shadow-md);
            min-width: 180px;
            text-align: center;
        }

        .active-users-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .active-users-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-info);
            line-height: 1;
            letter-spacing: -0.02em;
        }

        .active-users-text {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Collapsible section for pivot table */
        .collapsible-section {
            position: relative;
            z-index: 1;
            margin-bottom: 20px;
        }

        .section-header {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .section-header:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--accent-info);
        }

        .section-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        /* Master section for Usage Analysis */
        .master-section {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: 0;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .master-section-header {
            padding: 14px 18px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            border-radius: 12px;
        }

        .master-section-header:hover {
            background: var(--bg-secondary);
        }

        .master-section-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: -0.015em;
            color: var(--accent-info);
        }

        .master-section-content {
            padding: 12px 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 10000px;
            opacity: 1;
            border-top: 2px solid var(--border);
        }

        .master-section-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
            border-top: none;
        }

        /* Nested sections inside master */
        .master-section .collapsible-section {
            margin-bottom: 10px;
        }

        .master-section .section-header {
            background: var(--bg-secondary);
        }

        .collapse-icon {
            font-size: 1rem;
            color: var(--text-secondary);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            margin-top: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 2000px;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding: 0;
            border: none;
        }

        .pivot-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .pivot-table thead {
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .pivot-table th {
            text-align: right;
            padding: 8px 12px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: -0.01em;
            font-size: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        .pivot-table th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--bg-secondary);
            z-index: 11;
        }

        .pivot-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            text-align: right;
            transition: background 0.2s ease;
        }

        .pivot-table td:first-child {
            text-align: left;
            font-weight: 600;
            position: sticky;
            left: 0;
            background: var(--bg-card);
            z-index: 5;
        }

        .pivot-table tr:hover td {
            background: var(--bg-secondary);
        }

        .pivot-table tr:hover td:first-child {
            background: var(--bg-secondary);
        }

        .pivot-table .total-row {
            font-weight: 600;
            background: var(--bg-secondary);
            border-top: 2px solid var(--border);
        }

        .pivot-table .total-row:hover td {
            background: var(--bg-secondary);
        }

        .pivot-table-container {
            overflow-x: auto;
            margin-top: 10px;
        }

        /* Credit Calculator */
        .calculator-section {
            position: relative;
            z-index: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 0;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .calculator-section:hover {
            border-color: var(--accent-info);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .calculator-section .section-header:hover {
            background: transparent;
        }

        .calculator-header {
            margin-bottom: 12px;
        }

        .calculator-header h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 2px;
            letter-spacing: -0.015em;
        }

        .calculator-header p {
            color: var(--text-secondary);
            font-size: 0.8125rem;
        }

        .software-inputs {
            display: grid;
            gap: 8px;
            margin-bottom: 12px;
        }

        .software-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 6px;
            align-items: center;
            padding: 6px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .software-row select,
        .software-row input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 0.8125rem;
            transition: all 0.2s ease;
        }

        .software-row select:focus,
        .software-row input:focus {
            outline: none;
            border-color: var(--accent-info);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .add-software-btn,
        .remove-software-btn {
            background: var(--accent-info);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .add-software-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .remove-software-btn {
            background: var(--accent-danger);
            padding: 6px 10px;
        }

        .remove-software-btn:hover {
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
        }

        .calculator-result {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-row:last-child {
            border-bottom: none;
            padding-top: 8px;
            margin-top: 4px;
            border-top: 2px solid var(--border);
        }

        .result-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .result-value {
            font-size: 0.9375rem;
            font-weight: 600;
        }

        .alert-box {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.8125rem;
        }

        .alert-box.safe {
            background: rgba(52, 199, 89, 0.12);
            color: var(--accent-success);
        }

        .alert-box.warning {
            background: rgba(255, 149, 0, 0.12);
            color: var(--accent-warning);
        }

        .alert-box.critical {
            background: rgba(255, 59, 48, 0.12);
            color: var(--accent-danger);
        }

        .notify-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid currentColor;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            margin-left: auto;
            flex-shrink: 0;
        }

        .notify-btn:hover {
            background: white;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .notify-btn.warning {
            color: var(--accent-warning);
        }

        .notify-btn.critical {
            color: var(--accent-danger);
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        @media (max-width: 1024px) {
            .upload-grid,
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Responsive Design - Auto-resize based on browser width */
        @media (max-width: 1400px) {
            .dashboard-container {
                max-width: 100%;
                padding: 30px 25px;
            }

            .calculator-upload-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }

        @media (max-width: 1200px) {
            h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                max-width: 95%;
            }

            .master-section-content {
                padding: 16px;
            }

            /* Stack calculator and upload vertically on medium screens */
            .calculator-upload-grid {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 900px) {
            .dashboard-container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 1.75rem;
            }

            .stats-grid {
                max-width: 100%;
                grid-template-columns: repeat(2, 1fr);
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                padding: 12px 16px;
                font-size: 1rem;
            }

            .section-header h2 {
                font-size: 1rem;
            }

            .master-section-header {
                padding: 16px 20px;
            }

            .master-section-header h2 {
                font-size: 1.25rem;
            }
        }

        @media (max-width: 600px) {
            .dashboard-container {
                padding: 15px 10px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .subtitle {
                font-size: 0.8125rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                max-width: 100%;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .active-users-box {
                position: relative;
                top: auto;
                right: auto;
                margin: 16px auto;
                display: block;
            }

            .dark-mode-toggle {
                top: 15px;
                right: 10px;
                padding: 8px 12px;
                font-size: 0.8125rem;
            }

            .calculator-section,
            .settings-section {
                padding: 12px;
            }

            .upload-section {
                padding: 16px;
            }

            .upload-section h3 {
                font-size: 1rem;
            }

            .collapsible-section {
                margin-bottom: 16px;
            }

            .section-header h2 {
                font-size: 0.9375rem;
            }

            .master-section-header h2 {
                font-size: 1.125rem;
            }

            .software-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .software-row select,
            .software-row input {
                font-size: 0.8125rem;
            }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <div class="dark-mode-toggle" onclick="toggleDarkMode()">
        <span id="themeIcon">üåô</span>
        <span id="themeText">Dark</span>
    </div>

    <div class="active-users-box">
        <div class="active-users-label">Active Users</div>
        <div class="active-users-number" id="activeUsersNumber">0</div>
        <div class="active-users-text">this week</div>
    </div>

    <div class="dashboard-container">
        <header>
            <h1>ANSYS AEC Usage</h1>
            <p class="subtitle">Real-time credit monitoring & insights</p>
            <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                <div style="padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;">
                    <span style="font-size: 0.75rem; color: var(--text-secondary); display: block;">Current Balance</span>
                    <span style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary);" id="headerBalance">834.2 AEC</span>
                </div>
                <div style="padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;">
                    <span style="font-size: 0.75rem; color: var(--text-secondary); display: block;">Balance Last Updated</span>
                    <span style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary);" id="balanceUpdateDate">December 3, 2024</span>
                </div>
                <div style="padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;" id="historicalUploadSection">
                    <span style="font-size: 0.75rem; color: var(--text-secondary); display: block;">Historical Data</span>
                    <span style="font-size: 0.75rem; color: var(--accent-success);" id="historicalStatus"></span>
                    <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); display: block;" id="historicalDateRange"></span>
                    <input type="file" id="historicalFile" accept=".csv" style="display: none;">
                </div>
                <div style="padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;" id="recentUploadSection">
                    <span style="font-size: 0.75rem; color: var(--text-secondary); display: block;">Recent Data</span>
                    <span style="font-size: 0.75rem; color: var(--accent-success);" id="recentStatus"></span>
                    <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); display: block;" id="recentDateRange"></span>
                    <input type="file" id="recentFile" accept=".csv" style="display: none;">
                </div>
            </div>
        </header>

        <div class="calculator-upload-grid" style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- Calculator -->
            <div>
                <div class="master-section">
            <div class="master-section-header" onclick="toggleSection('calculatorContent', 'calculatorIcon')">
                <h2>üí° Credit Usage Calculator</h2>
                <span class="collapse-icon" id="calculatorIcon">‚ñº</span>
            </div>

            <div class="master-section-content" id="calculatorContent">

            <div class="software-inputs" id="softwareInputs">
                <div class="software-row">
                    <select class="software-select">
                        <option value="">Select Software...</option>
                        <optgroup label="Pre/Post Processing">
                            <option value="blademodeler">BladeModeler (2 AEC/hour)</option>
                            <option value="cfd_preppost">CFD PrepPost (14 AEC/hour)</option>
                            <option value="designmodeler">DesignModeler (14 AEC/hour)</option>
                            <option value="electronics_preppost">Electronics Desktop PrepPost (14 AEC/hour)</option>
                            <option value="spaceclaim">SpaceClaim (14 AEC/hour)</option>
                        </optgroup>
                        <optgroup label="Solvers - Most Common">
                            <option value="discovery_enterprise">Discovery Enterprise (18 AEC/hour)</option>
                            <option value="mechanical_solver">Mechanical Enterprise Solver (28 AEC/hour)</option>
                            <option value="fluent">CFD Enterprise Solver (28 AEC/hour)</option>
                            <option value="electronics_solver">Electronics Enterprise Solver (28 AEC/hour)</option>
                            <option value="hfss_solver">HFSS Solver (28 AEC/hour)</option>
                            <option value="maxwell_solver">Maxwell Solver (28 AEC/hour)</option>
                            <option value="icepak_solver">Icepak Solver (28 AEC/hour)</option>
                            <option value="lsdyna">LS-DYNA (28 AEC/hour)</option>
                        </optgroup>
                        <optgroup label="Solvers - Other">
                            <option value="aim">AIM (28 AEC/hour)</option>
                            <option value="additive_suite">Additive Suite (39 AEC/hour)</option>
                            <option value="electronics_2d">Electronics Desktop 2D Solver (14 AEC/hour)</option>
                            <option value="hfss_sbr">HFSS SBR + Solver (28 AEC/hour)</option>
                            <option value="lumerical_solver">Lumerical Enterprise Solver (28 AEC/hour)</option>
                            <option value="motion_enterprise">Motion Enterprise (50 AEC/hour)</option>
                            <option value="motion_premium">Motion Premium (25 AEC/hour)</option>
                            <option value="motorcad_blackbox">Motor-CAD Blackbox (10 AEC/hour)</option>
                            <option value="motorcad_enterprise">Motor-CAD Enterprise (27 AEC/hour)</option>
                            <option value="ncode_designlife">nCode DesignLife Enterprise (39 AEC/hour)</option>
                            <option value="q3d_extractor">Q3D Extractor 3D Solver (28 AEC/hour)</option>
                            <option value="rf_option">RF Option (28 AEC/hour)</option>
                            <option value="rocky">Rocky (34 AEC/hour)</option>
                            <option value="sherlock">Sherlock (53 AEC/hour)</option>
                            <option value="siwave_psi">SIwave PSI Solver (28 AEC/hour)</option>
                            <option value="siwave_solver">SIwave Solver (28 AEC/hour)</option>
                            <option value="speos_enterprise_solver">Speos Enterprise Solver (46 AEC/hour)</option>
                            <option value="zemax">Zemax OpticStudio Enterprise (20 AEC/hour)</option>
                        </optgroup>
                        <optgroup label="Optimization">
                            <option value="cfd_ai">CFD AI+ (10 AEC/hour)</option>
                            <option value="designxplorer">DesignXplorer (7 AEC/hour)</option>
                            <option value="optimetrics">Optimetrics (7 AEC/hour)</option>
                            <option value="optislang_ai">optiSLang AI+ (16 AEC/hour)</option>
                            <option value="optislang_enterprise">optiSLang Enterprise (38 AEC/hour)</option>
                        </optgroup>
                        <optgroup label="Materials & Safety">
                            <option value="granta">GRANTA Materials Data for Simulation (33 AEC/hour)</option>
                            <option value="medini">medini analyze Enterprise (114 AEC/hour)</option>
                        </optgroup>
                        <optgroup label="Geometry Interfaces">
                            <option value="alinks">ALinks for EDA (7 AEC/hour)</option>
                            <option value="dso">Distributed Solve DSO (4 AEC/hour)</option>
                            <option value="geo_interface">Geometry Interfaces (4 AEC/hour)</option>
                        </optgroup>
                    </select>
                    <input type="number" class="hours-input" placeholder="Hours" min="0" step="0.5">
                    <input type="number" class="weeks-input" placeholder="Weeks" min="1" value="1" step="1">
                    <button class="remove-software-btn" onclick="removeSoftwareRow(this)" style="visibility: hidden;">‚úï</button>
                </div>
            </div>

            <button class="add-software-btn" onclick="addSoftwareRow()">+ Add Another Software</button>

            <div class="calculator-result">
                <div class="result-row">
                    <span class="result-label">Total Credits Needed</span>
                    <span class="result-value" id="totalCredits">0.0 AEC</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Current Balance</span>
                    <span class="result-value" id="currentBalance">5,000.0 AEC</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Remaining After Usage</span>
                    <span class="result-value" id="remainingCredits">5,000.0 AEC</span>
                </div>
                <div id="alertMessage"></div>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <button class="purchase-btn" onclick="calculateUsage()" style="flex: 1; padding: 8px; font-size: 0.875rem;">
                    Calculate
                </button>
                <button class="purchase-btn" onclick="exportQuoteToPDF()" style="padding: 8px 16px; font-size: 0.8125rem; background: linear-gradient(135deg, var(--accent-teal), var(--accent-info)); white-space: nowrap;">
                    üìÑ Export as Quote
                </button>
            </div>
            </div>
        </div>
        </div>
        </div>

        <div id="dashboardContent" class="hidden">
            <div class="master-section">
                <div class="master-section-header" onclick="toggleSection('usageAnalysisContent', 'usageAnalysisIcon')">
                    <h2>üìä Usage Analysis</h2>
                    <span class="collapse-icon collapsed" id="usageAnalysisIcon">‚ñº</span>
                </div>
                <div class="master-section-content collapsed" id="usageAnalysisContent">

                    <!-- Sidebar Layout -->
                    <div class="sidebar-layout">
                        <!-- Sidebar Navigation -->
                        <div class="sidebar-nav">
                            <button class="sidebar-nav-item active" onclick="showSidebarPanel('alerts')">
                                ‚ö° Usage Alerts
                            </button>
                            <button class="sidebar-nav-item" onclick="showSidebarPanel('comparison')">
                                üë• User Comparison
                            </button>
                            <button class="sidebar-nav-item" onclick="showSidebarPanel('monthly')">
                                üìä Monthly Usage
                            </button>
                            <button class="sidebar-nav-item" onclick="showSidebarPanel('settings')">
                                ‚öôÔ∏è Settings
                            </button>
                        </div>

                        <!-- Sidebar Content -->
                        <div class="sidebar-content">
                            <!-- Usage Alerts Panel -->
                            <div class="sidebar-panel active" id="panel-alerts">
                                <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">‚ö° Usage Alerts</h3>
                                
                                <div class="stats-grid" style="margin-bottom: 16px;">
                                    <div class="stat-card">
                                        <div class="stat-label">Historical Avg/Month</div>
                                        <div class="stat-value" id="historicalAvg" style="color: var(--accent-teal);">0</div>
                                        <div class="stat-subtext">AEC</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Recent Weekly Usage</div>
                                        <div class="stat-value" id="recentWeekly" style="color: var(--accent-info);">0</div>
                                        <div class="stat-subtext">AEC</div>
                                        <div id="weeklyTrend"></div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Projected Monthly</div>
                                        <div class="stat-value" id="projectedMonthly" style="color: var(--accent-warning);">0</div>
                                        <div class="stat-subtext">AEC</div>
                                        <div id="projectionTrend"></div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Balance Runway</div>
                                        <div class="stat-value" id="runwayMonths" style="color: var(--accent-success);">0</div>
                                        <div class="stat-subtext">weeks remaining</div>
                                    </div>
                                </div>

                                <div id="alertsList"></div>
                            </div>

                            <!-- User Comparison Panel -->
                            <div class="sidebar-panel" id="panel-comparison">
                                <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">üë• User Comparison</h3>
                                <div class="comparison-grid">
                                    <div class="comparison-card">
                                        <h3>
                                            <span class="period-badge historical">Historical</span>
                                            Average Usage
                                        </h3>
                                        <div id="historicalUserTable"></div>
                                    </div>
                                    <div class="comparison-card">
                                        <h3>
                                            <span class="period-badge recent">Recent Week</span>
                                            Current Usage
                                        </h3>
                                        <div id="recentUserTable"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Monthly Usage Panel -->
                            <div class="sidebar-panel" id="panel-monthly">
                                <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">üìä Monthly Usage by User</h3>
                                <div class="pivot-table-container">
                                    <table class="pivot-table" id="pivotTable">
                                        <thead>
                                            <tr id="pivotTableHeader">
                                                <th>Username</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pivotTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Settings Panel -->
                            <div class="sidebar-panel" id="panel-settings">
                                <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">‚öôÔ∏è Alert Settings</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label>Available Balance (AEC)</label>
                                        <input type="number" id="availableBalance" value="" min="0">
                                    </div>
                                    <div class="setting-item">
                                        <label>Lead Time (weeks)</label>
                                        <input type="number" id="leadTimeWeeks" value="2" min="0" step="0.5">
                                    </div>
                                    <div class="setting-item">
                                        <label>Purchase Amount (AEC)</label>
                                        <input type="number" id="purchaseAmount" value="5000" min="0">
                                    </div>
                                    <div class="setting-item">
                                        <label>Acceleration Alert (%)</label>
                                        <input type="number" id="accelThreshold" value="50" min="0">
                                    </div>
                                </div>
                                <div id="calculatedThresholds" style="margin-top: 12px; padding: 12px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);">
                                    <h4 style="font-size: 0.75rem; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Calculated Thresholds</h4>
                                    <div style="display: flex; gap: 16px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.6875rem; color: var(--text-secondary);">Critical Weekly</div>
                                            <div id="criticalWeeklyRate" style="font-size: 0.8125rem; font-weight: 600; color: var(--accent-danger);">-</div>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.6875rem; color: var(--text-secondary);">Warning Weekly</div>
                                            <div id="warningWeeklyRate" style="font-size: 0.8125rem; font-weight: 600; color: var(--accent-warning);">-</div>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.6875rem; color: var(--text-secondary);">Safe Weekly</div>
                                            <div id="safeWeeklyRate" style="font-size: 0.8125rem; font-weight: 600; color: var(--accent-success);">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

            </div>
            </div>
        
        <!-- Administrative Tools Section -->
        <div class="master-section" style="margin-top: 20px;">
            <div class="master-section-header" onclick="toggleSection('adminToolsContent', 'adminToolsIcon')">
                <h2>üîß Administrative Tools</h2>
                <span class="collapse-icon collapsed" id="adminToolsIcon">‚ñº</span>
            </div>
            <div class="master-section-content collapsed" id="adminToolsContent">

                <!-- Previous Month Software Usage by User -->
                <div id="monthlyPieChartsSection" style="background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow-sm); margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <h2 style="margin-bottom: 4px; font-size: 1rem; font-weight: 600; color: var(--accent-teal);">
                                üìä Previous Month Usage Report
                            </h2>
                            <p style="color: var(--text-secondary); font-size: 0.8125rem;">
                                Software usage breakdown by user for <strong id="monthlyReportMonth"></strong>
                            </p>
                        </div>
                        <button class="purchase-btn" onclick="emailAllUsers()" style="padding: 8px 16px; font-size: 0.8125rem; background: linear-gradient(135deg, var(--accent-teal), var(--accent-info)); white-space: nowrap;">
                            üìß Email Each User
                        </button>
                    </div>
                    <div id="monthlyPieChartsContainer" style="display: flex; flex-wrap: nowrap; gap: 16px; margin-top: 16px; overflow-x: auto; padding-bottom: 8px;">
                        <!-- Pie charts will be inserted here -->
                    </div>
                </div>

                <!-- Running Low on Credits -->
                <div class="purchase-section" id="purchaseSection">
                    <h2 style="margin-bottom: 12px; font-size: 1rem; font-weight: 600;">Running Low on Credits?</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.8125rem;">
                        Current balance: <strong id="balanceWarning" style="color: var(--accent-warning);">0 AEC</strong><br>
                        Projected depletion: <strong id="depletionWarning" style="color: var(--accent-danger);"></strong><br>
                        <span id="depletionWeeks" style="font-size: 0.75rem;"></span>
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button class="purchase-btn pulse" onclick="requestPurchase()" style="padding: 8px 16px; font-size: 0.8125rem;">
                            Request More AECs
                        </button>
                        <button class="purchase-btn" style="background: linear-gradient(135deg, var(--accent-teal), var(--accent-info)); box-shadow: 0 4px 16px rgba(0, 91, 127, 0.3); padding: 8px 16px; font-size: 0.8125rem;" onclick="exportToTeams()">
                            Update the Team
                        </button>
                    </div>
                </div>

            </div>
        </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - Update these values
        // ============================================
        const INITIAL_BALANCE = 834.2;  // Update this with current AEC balance
        const BALANCE_UPDATE_DATE = "December 3, 2025";  // Fallback date (auto-detected from recent CSV data)
        const ACTIVE_USERS_THIS_WEEK = 3;  // Fallback value (auto-detected from unique usernames in recent CSV)

        // CSV File URLs - Update these with your hosted file locations
        const HISTORICAL_CSV_URL = "https://raw.githubusercontent.com/nataccccha/ansys-credit-tracking/refs/heads/main/data/historical.csv";
        const RECENT_CSV_URL = "https://raw.githubusercontent.com/nataccccha/ansys-credit-tracking/refs/heads/main/data/recent.csv";
        const AUTO_LOAD_CSV = true;    // Set to true to automatically load CSV files on page load

        // Dark mode toggle
        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            
            if (newTheme === 'dark') {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Light';
            } else {
                icon.textContent = 'üåô';
                text.textContent = 'Dark';
            }
        }

        // Load saved theme
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeText').textContent = 'Light';
            }

            // Load collapsed states for all sections
            ['usageAnalysisContent', 'alertsContent', 'comparisonContent', 'pivotContent'].forEach(sectionId => {
                const isCollapsed = localStorage.getItem(sectionId + 'Collapsed') === 'true';
                if (isCollapsed) {
                    document.getElementById(sectionId).classList.add('collapsed');
                    document.getElementById(sectionId.replace('Content', 'Icon')).classList.add('collapsed');
                }
            });

            // Calculator starts expanded by default (ignore localStorage for first load)
            if (!localStorage.getItem('calculatorContentFirstLoad')) {
                localStorage.setItem('calculatorContentFirstLoad', 'true');
                localStorage.removeItem('calculatorContentCollapsed');
            }

            // Auto-load CSV files if enabled
            if (AUTO_LOAD_CSV && HISTORICAL_CSV_URL && RECENT_CSV_URL) {
                loadCSVFromURL(HISTORICAL_CSV_URL, 'historical');
                loadCSVFromURL(RECENT_CSV_URL, 'recent');
            }
        });

        // Software consumption rates (AEC per hour) from official ANSYS table
        const softwareRates = {
            // Pre/Post
            blademodeler: 2,
            cfd_preppost: 14,
            designmodeler: 14,
            electronics_preppost: 14,
            spaceclaim: 14,
            // Solvers - Most Common
            discovery_enterprise: 18,
            mechanical_solver: 28,
            fluent: 28,
            electronics_solver: 28,
            hfss_solver: 28,
            maxwell_solver: 28,
            icepak_solver: 28,
            lsdyna: 28,
            // Solvers - Other
            aim: 28,
            additive_suite: 39,
            electronics_2d: 14,
            hfss_sbr: 28,
            lumerical_solver: 28,
            motion_enterprise: 50,
            motion_premium: 25,
            motorcad_blackbox: 10,
            motorcad_enterprise: 27,
            ncode_designlife: 39,
            q3d_extractor: 28,
            rf_option: 28,
            rocky: 34,
            sherlock: 53,
            siwave_psi: 28,
            siwave_solver: 28,
            speos_enterprise_solver: 46,
            zemax: 20,
            // Optimization
            cfd_ai: 10,
            designxplorer: 7,
            optimetrics: 7,
            optislang_ai: 16,
            optislang_enterprise: 38,
            // Materials & Safety
            granta: 33,
            medini: 114,
            // Geometry Interfaces
            alinks: 7,
            dso: 4,
            geo_interface: 4
        };

        // Add software row
        function addSoftwareRow() {
            const container = document.getElementById('softwareInputs');
            const newRow = document.createElement('div');
            newRow.className = 'software-row';
            newRow.innerHTML = `
                <select class="software-select">
                    <option value="">Select Software...</option>
                    <optgroup label="Pre/Post Processing">
                        <option value="blademodeler">BladeModeler (2 AEC/hour)</option>
                        <option value="cfd_preppost">CFD PrepPost (14 AEC/hour)</option>
                        <option value="designmodeler">DesignModeler (14 AEC/hour)</option>
                        <option value="electronics_preppost">Electronics Desktop PrepPost (14 AEC/hour)</option>
                        <option value="spaceclaim">SpaceClaim (14 AEC/hour)</option>
                    </optgroup>
                    <optgroup label="Solvers - Most Common">
                        <option value="discovery_enterprise">Discovery Enterprise (18 AEC/hour)</option>
                        <option value="mechanical_solver">Mechanical Enterprise Solver (28 AEC/hour)</option>
                        <option value="fluent">CFD Enterprise Solver (28 AEC/hour)</option>
                        <option value="electronics_solver">Electronics Enterprise Solver (28 AEC/hour)</option>
                        <option value="hfss_solver">HFSS Solver (28 AEC/hour)</option>
                        <option value="maxwell_solver">Maxwell Solver (28 AEC/hour)</option>
                        <option value="icepak_solver">Icepak Solver (28 AEC/hour)</option>
                        <option value="lsdyna">LS-DYNA (28 AEC/hour)</option>
                    </optgroup>
                    <optgroup label="Solvers - Other">
                        <option value="aim">AIM (28 AEC/hour)</option>
                        <option value="additive_suite">Additive Suite (39 AEC/hour)</option>
                        <option value="electronics_2d">Electronics Desktop 2D Solver (14 AEC/hour)</option>
                        <option value="hfss_sbr">HFSS SBR + Solver (28 AEC/hour)</option>
                        <option value="lumerical_solver">Lumerical Enterprise Solver (28 AEC/hour)</option>
                        <option value="motion_enterprise">Motion Enterprise (50 AEC/hour)</option>
                        <option value="motion_premium">Motion Premium (25 AEC/hour)</option>
                        <option value="motorcad_blackbox">Motor-CAD Blackbox (10 AEC/hour)</option>
                        <option value="motorcad_enterprise">Motor-CAD Enterprise (27 AEC/hour)</option>
                        <option value="ncode_designlife">nCode DesignLife Enterprise (39 AEC/hour)</option>
                        <option value="q3d_extractor">Q3D Extractor 3D Solver (28 AEC/hour)</option>
                        <option value="rf_option">RF Option (28 AEC/hour)</option>
                        <option value="rocky">Rocky (34 AEC/hour)</option>
                        <option value="sherlock">Sherlock (53 AEC/hour)</option>
                        <option value="siwave_psi">SIwave PSI Solver (28 AEC/hour)</option>
                        <option value="siwave_solver">SIwave Solver (28 AEC/hour)</option>
                        <option value="speos_enterprise_solver">Speos Enterprise Solver (46 AEC/hour)</option>
                        <option value="zemax">Zemax OpticStudio Enterprise (20 AEC/hour)</option>
                    </optgroup>
                    <optgroup label="Optimization">
                        <option value="cfd_ai">CFD AI+ (10 AEC/hour)</option>
                        <option value="designxplorer">DesignXplorer (7 AEC/hour)</option>
                        <option value="optimetrics">Optimetrics (7 AEC/hour)</option>
                        <option value="optislang_ai">optiSLang AI+ (16 AEC/hour)</option>
                        <option value="optislang_enterprise">optiSLang Enterprise (38 AEC/hour)</option>
                    </optgroup>
                    <optgroup label="Materials & Safety">
                        <option value="granta">GRANTA Materials Data for Simulation (33 AEC/hour)</option>
                        <option value="medini">medini analyze Enterprise (114 AEC/hour)</option>
                    </optgroup>
                    <optgroup label="Geometry Interfaces">
                        <option value="alinks">ALinks for EDA (7 AEC/hour)</option>
                        <option value="dso">Distributed Solve DSO (4 AEC/hour)</option>
                        <option value="geo_interface">Geometry Interfaces (4 AEC/hour)</option>
                    </optgroup>
                </select>
                <input type="number" class="hours-input" placeholder="Hours" min="0" step="0.5">
                <input type="number" class="weeks-input" placeholder="Weeks" min="1" value="1" step="1">
                <button class="remove-software-btn" onclick="removeSoftwareRow(this)">‚úï</button>
            `;
            container.appendChild(newRow);
        }

        // Remove software row
        function removeSoftwareRow(button) {
            button.closest('.software-row').remove();
        }

        // Calculate usage
        function calculateUsage() {
            const rows = document.querySelectorAll('.software-row');
            let totalCredits = 0;
            let totalWeeks = 0;

            // Calculate total credits needed and track weeks
            rows.forEach(row => {
                const software = row.querySelector('.software-select').value;
                const hours = parseFloat(row.querySelector('.hours-input').value) || 0;
                const weeks = parseFloat(row.querySelector('.weeks-input').value) || 1;

                if (software && hours > 0) {
                    const rate = softwareRates[software];
                    totalCredits += rate * hours * weeks;
                    totalWeeks = Math.max(totalWeeks, weeks); // Track the longest duration
                }
            });

            // Calculate weekly burn rate (average per week)
            const weeklyBurnRate = totalWeeks > 0 ? totalCredits / totalWeeks : totalCredits;

            // Get current balance from settings or default
            const currentBalance = settings.availableBalance || 5000;
            const remaining = currentBalance - totalCredits;

            // Simple check: Does planned usage exceed current balance?
            // Critical: If usage exceeds current balance
            const isCritical = totalCredits > currentBalance;
            
            // Warning: If usage is close to current balance (within 85%)
            const isWarning = !isCritical && totalCredits > (currentBalance * 0.85);
            
            // Additional warnings
            const highBurnRate = weeklyBurnRate > 750; // Warning if burning more than 750 AEC/week
            const lowRemaining = remaining < 1500 && remaining > 0; // Warning if remaining drops below 1500 AEC

            // Update display
            document.getElementById('totalCredits').textContent = totalCredits.toFixed(1) + ' AEC';
            document.getElementById('currentBalance').textContent = currentBalance.toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + ' AEC';
            document.getElementById('remainingCredits').textContent = remaining.toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + ' AEC';
            
            // Build additional warning messages (text only, to be combined)
            let additionalWarningTexts = [];
            if (highBurnRate) {
                additionalWarningTexts.push(`<strong>HIGH BURN RATE:</strong> Your weekly usage rate (${weeklyBurnRate.toFixed(1)} AEC/week) exceeds 750 AEC/week.`);
            }
            if (lowRemaining && !isCritical) {
                additionalWarningTexts.push(`<strong>LOW BALANCE:</strong> After this usage, your remaining balance (${remaining.toFixed(1)} AEC) will be below 1,500 AEC.`);
            }

            // Determine alert level
            const alertDiv = document.getElementById('alertMessage');
            
            // Add note about active users (get current count from display)
            const activeUsersCount = parseInt(document.getElementById('activeUsersNumber').textContent) || 0;
            let activeUsersNote = '';
            if (activeUsersCount > 0) {
                activeUsersNote = `<div style="margin-top: 8px; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--accent-info); border-radius: 6px; font-size: 0.8125rem;">
                    <strong style="color: var(--accent-info);">üìä Note:</strong> There are currently <strong>${activeUsersCount}</strong> other user${activeUsersCount > 1 ? 's' : ''} running simulations this week. 
                    If you're planning computationally heavy work, please check with the administrator to avoid credit conflicts.
                </div>`;
            }
            
            // Determine alert based on whether usage exceeds balance
            if (isCritical) {
                // Build combined message for critical alert
                let criticalMessages = [`Your planned usage (${totalCredits.toFixed(1)} AEC) exceeds your current balance (${currentBalance.toFixed(1)} AEC). You are short by ${(totalCredits - currentBalance).toFixed(1)} AEC.`];
                additionalWarningTexts.forEach(msg => criticalMessages.push(msg));
                
                alertDiv.innerHTML = `
                    <div class="alert-box critical">
                        <span class="alert-icon">üö®</span>
                        <div>
                            <strong>ALERT REQUIRED:</strong> ${criticalMessages.join('<br>')}
                        </div>
                        <button class="notify-btn critical" onclick="openNatachaEmail('critical', ${totalCredits.toFixed(1)}, ${currentBalance.toFixed(1)}, ${remaining.toFixed(1)}, ${weeklyBurnRate.toFixed(1)}, ${totalWeeks})">
                            üìß Notify
                        </button>
                    </div>
                    ${activeUsersNote}
                `;
            } else if (isWarning || highBurnRate || lowRemaining) {
                // Build combined warning messages
                let warningMessages = [];
                if (highBurnRate) {
                    warningMessages.push(`High burn rate (${weeklyBurnRate.toFixed(1)} AEC/week exceeds 750 AEC/week)`);
                }
                if (lowRemaining) {
                    warningMessages.push(`Remaining balance (${remaining.toFixed(1)} AEC) will be below 1,500 AEC`);
                }
                if (isWarning && !highBurnRate && !lowRemaining) {
                    warningMessages.push(`Planned usage will consume most of your balance`);
                }
                
                alertDiv.innerHTML = `
                    <div class="alert-box warning">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div>
                            <strong>CAUTION:</strong> ${warningMessages.join('<br>')}
                            <br>Planned: ${totalCredits.toFixed(1)} AEC | Balance: ${currentBalance.toFixed(1)} AEC | Remaining: ${remaining.toFixed(1)} AEC.
                        </div>
                        <button class="notify-btn warning" onclick="openNatachaEmail('warning', ${totalCredits.toFixed(1)}, ${currentBalance.toFixed(1)}, ${remaining.toFixed(1)}, ${weeklyBurnRate.toFixed(1)}, ${totalWeeks})">
                            üìß Notify
                        </button>
                    </div>
                    ${activeUsersNote}
                `;
            } else {
                alertDiv.innerHTML = `
                    <div class="alert-box safe">
                        <span class="alert-icon">‚úÖ</span>
                        <div>
                            <strong>SAFE:</strong> Your planned usage is within available balance. 
                            Planned: ${totalCredits.toFixed(1)} AEC | Balance: ${currentBalance.toFixed(1)} AEC | Remaining: ${remaining.toFixed(1)} AEC (${(remaining / weeklyBurnRate).toFixed(1)} weeks at current rate). 
                            No action needed.
                        </div>
                    </div>
                    ${activeUsersNote}
                `;
            }
        }
        
        // Open Outlook Web directly to email Natacha
        function openNatachaEmail(alertType, plannedUsage, currentBalance, remaining, weeklyRate, weeks) {
            // Get software list from calculator
            const rows = document.querySelectorAll('.software-row');
            let softwareList = '';
            rows.forEach(row => {
                const software = row.querySelector('.software-select').selectedOptions[0]?.text;
                const hours = row.querySelector('.hours-input').value;
                const weeksVal = row.querySelector('.weeks-input').value;
                if (software && hours > 0) {
                    softwareList += `‚Ä¢ ${software}: ${hours} hrs/week √ó ${weeksVal} week(s)\n`;
                }
            });
            
            const subject = alertType === 'critical' 
                ? 'URGENT: ANSYS AEC Credit Request - Balance Exceeded'
                : 'ANSYS AEC Credit Alert - Low Balance Warning';
            
            const body = `Hi Natacha,

I am planning to run ANSYS simulations and wanted to notify you about our credit situation.

PLANNED USAGE
${softwareList}
Total Duration: ${weeks} week(s)
Weekly Burn Rate: ${weeklyRate} AEC/week
Total AEC Required: ${plannedUsage} AEC

CURRENT STATUS
Current Balance: ${currentBalance} AEC
Remaining After Usage: ${remaining} AEC
${alertType === 'critical' ? `Shortfall: ${(plannedUsage - currentBalance).toFixed(1)} AEC` : ''}

${alertType === 'critical' 
    ? 'ACTION NEEDED: We need additional credits to proceed with this simulation. Please advise on next steps.'
    : 'HEADS UP: Our balance will be running low after this usage. We may need to order more credits soon.'}

Please let me know if you have any questions.

Thanks,`;

            // Create Outlook web deeplink
            const outlookUrl = `https://outlook.office365.us/owa/arete.com/?path=/mail/action/compose&to=${encodeURIComponent('nramioulle@arete.com')}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open Outlook web
            window.open(outlookUrl, '_blank');
        }

        // Load CSV from URL
        async function loadCSVFromURL(url, type) {
            const statusId = type === 'historical' ? 'historicalStatus' : 'recentStatus';
            const sectionId = type === 'historical' ? 'historicalUploadSection' : 'recentUploadSection';
            const dateRangeId = type === 'historical' ? 'historicalDateRange' : 'recentDateRange';
            
            try {
                document.getElementById(statusId).innerHTML = `<span style="color: var(--accent-info);">Loading from server...</span>`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to load: ${response.status}`);
                }
                
                const csvText = await response.text();
                const data = parseCSV(csvText);
                
                if (type === 'historical') {
                    historicalData = data;
                } else {
                    recentData = data;
                    // Extract the most recent date from recent data
                    updateBalanceDateFromData(data);
                }
                
                // Calculate date range from data
                const dateRange = getDateRangeFromData(data);
                
                document.getElementById(statusId).innerHTML = `<span style="color: var(--accent-success);">‚úì Loaded from server</span>`;
                document.getElementById(dateRangeId).innerHTML = `Data: ${dateRange}`;
                document.getElementById(sectionId).classList.add('loaded');
                
                if (historicalData.length > 0 && recentData.length > 0) {
                    setTimeout(() => {
                        document.getElementById('dashboardContent').classList.remove('hidden');
                        updateDashboard();
                    }, 300);
                }
            } catch (error) {
                document.getElementById(statusId).innerHTML = `<span style="color: var(--accent-danger);">‚úó Failed to load: ${error.message}</span>`;
                console.error(`Error loading ${type} CSV:`, error);
            }
        }
        
        // Get date range from data
        function getDateRangeFromData(data) {
            if (!data || data.length === 0) return 'No data';
            
            let minDate = null;
            let maxDate = null;
            
            data.forEach(row => {
                const dateStr = row['End Time'] || row['Start Time'];
                if (dateStr) {
                    const date = new Date(dateStr);
                    if (!minDate || date < minDate) minDate = date;
                    if (!maxDate || date > maxDate) maxDate = date;
                }
            });
            
            if (!minDate || !maxDate) return 'No dates found';
            
            const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            return `${formatDate(minDate)} - ${formatDate(maxDate)}`;
        }

        // Update balance date from most recent data entry
        function updateBalanceDateFromData(data) {
            if (!data || data.length === 0) return;
            
            // Find the most recent date in the data
            let mostRecentDate = null;
            
            data.forEach(row => {
                const endTime = row['End Time'] || row['Start Time'];
                if (endTime) {
                    const date = new Date(endTime);
                    if (!mostRecentDate || date > mostRecentDate) {
                        mostRecentDate = date;
                    }
                }
            });
            
            if (mostRecentDate) {
                // Format the date
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = mostRecentDate.toLocaleDateString('en-US', options);
                
                // Update the display
                const balanceDateElement = document.getElementById('balanceUpdateDate');
                balanceDateElement.textContent = formattedDate;
                
                // Check if balance is more than a week old
                const today = new Date();
                const daysDifference = Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24));
                
                if (daysDifference > 7) {
                    balanceDateElement.style.color = 'var(--accent-danger)';
                    balanceDateElement.style.fontWeight = '700';
                    
                    // Add warning icon
                    const warningSpan = document.createElement('span');
                    warningSpan.innerHTML = ' ‚ö†Ô∏è';
                    warningSpan.style.fontSize = '1rem';
                    balanceDateElement.parentElement.appendChild(warningSpan);
                    
                    // Add warning message
                    const warningMsg = document.createElement('div');
                    warningMsg.style.marginTop = '8px';
                    warningMsg.style.padding = '8px 12px';
                    warningMsg.style.background = 'rgba(255, 59, 48, 0.12)';
                    warningMsg.style.color = 'var(--accent-danger)';
                    warningMsg.style.borderRadius = '6px';
                    warningMsg.style.fontSize = '0.8125rem';
                    warningMsg.style.fontWeight = '600';
                    warningMsg.innerHTML = '‚ö†Ô∏è Balance is ' + daysDifference + ' days old. Please update the administrator.';
                    balanceDateElement.parentElement.parentElement.appendChild(warningMsg);
                }
            }
            
            // Count unique users
            const uniqueUsers = new Set();
            data.forEach(row => {
                const username = row['Username'];
                if (username) {
                    uniqueUsers.add(username);
                }
            });
            
            // Update active users count
            const activeUsersCount = uniqueUsers.size;
            document.getElementById('activeUsersNumber').textContent = activeUsersCount;
        }

        // Toggle collapsible section
        function toggleSection(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            
            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');

            // Save state
            localStorage.setItem(contentId + 'Collapsed', content.classList.contains('collapsed'));
        }

        // Sidebar panel navigation
        function showSidebarPanel(panelName) {
            // Hide all panels
            document.querySelectorAll('.sidebar-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.sidebar-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected panel
            const panel = document.getElementById('panel-' + panelName);
            if (panel) {
                panel.classList.add('active');
            }
            
            // Set active nav item
            event.target.classList.add('active');
        }

        let historicalData = [];
        let recentData = [];
        let settings = {
            leadTimeWeeks: 2,
            accelThreshold: 50,
            availableBalance: INITIAL_BALANCE,
            purchaseAmount: 5000
        };
        let calculatedThresholds = {
            criticalWeekly: 0,
            warningWeekly: 0,
            safeWeekly: 0
        };

        // File upload handlers
        document.getElementById('historicalFile').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0], 'historical');
        });

        document.getElementById('recentFile').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0], 'recent');
        });

        // Drag and drop
        setupDragDrop('historicalUploadSection', 'historicalFile');
        setupDragDrop('recentUploadSection', 'recentFile');

        function setupDragDrop(sectionId, fileInputId) {
            const section = document.getElementById(sectionId);
            section.addEventListener('dragover', (e) => {
                e.preventDefault();
                section.classList.add('dragover');
            });
            section.addEventListener('dragleave', () => {
                section.classList.remove('dragover');
            });
            section.addEventListener('drop', (e) => {
                e.preventDefault();
                section.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    document.getElementById(fileInputId).files = e.dataTransfer.files;
                    handleFileUpload(file, fileInputId === 'historicalFile' ? 'historical' : 'recent');
                }
            });
        }

        // Settings change handlers
        ['leadTimeWeeks', 'accelThreshold', 'availableBalance', 'purchaseAmount'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                settings[id] = parseFloat(this.value);
                if (historicalData.length > 0 && recentData.length > 0) {
                    updateDashboard();
                }
            });
        });

        // Populate balance fields with initial values
        function populateBalanceFields() {
            const formattedBalance = INITIAL_BALANCE.toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + ' AEC';
            document.getElementById('availableBalance').value = INITIAL_BALANCE;
            document.getElementById('currentBalance').textContent = formattedBalance;
            document.getElementById('remainingCredits').textContent = formattedBalance;
            document.getElementById('headerBalance').textContent = formattedBalance;
        }

        // Call populate function on load
        populateBalanceFields();

        function handleFileUpload(file, type) {
            if (!file) return;
            
            const statusId = type === 'historical' ? 'historicalStatus' : 'recentStatus';
            const sectionId = type === 'historical' ? 'historicalUploadSection' : 'recentUploadSection';
            
            document.getElementById(statusId).innerHTML = `<span style="color: var(--accent-info);">Loading: ${file.name}</span>`;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = parseCSV(event.target.result);
                
                if (type === 'historical') {
                    historicalData = data;
                } else {
                    recentData = data;
                    // Update balance date from recent data
                    updateBalanceDateFromData(data);
                }
                
                document.getElementById(statusId).innerHTML = `<span style="color: var(--accent-success);">‚úì Loaded: ${file.name}</span>`;
                document.getElementById(sectionId).classList.add('loaded');
                
                if (historicalData.length > 0 && recentData.length > 0) {
                    setTimeout(() => {
                        document.getElementById('dashboardContent').classList.remove('hidden');
                        updateDashboard();
                    }, 300);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const row = {};
                headers.forEach((header, i) => {
                    row[header] = values[i] ? values[i].trim() : '';
                });
                return row;
            });
        }

        function updateDashboard() {
            // Calculate recent metrics first
            const recentTotal = recentData.reduce((sum, row) => sum + parseFloat(row['Cost'] || 0), 0);
            const totalUsers = new Set(recentData.map(row => row['Username'])).size;
            
            // Calculate dynamic thresholds based on burn rate and lead time
            // Critical: If we continue at this rate, will we run out before new credits arrive?
            // We need enough buffer for lead time + some safety margin
            const leadTimeBuffer = settings.leadTimeWeeks * 1.5; // 1.5x safety factor
            const warningBuffer = settings.leadTimeWeeks * 2; // 2x for early warning
            const safeBuffer = settings.leadTimeWeeks * 3; // 3x for comfortable operation
            
            // Calculate weekly rates based on available balance
            calculatedThresholds.criticalWeekly = settings.availableBalance / leadTimeBuffer;
            calculatedThresholds.warningWeekly = settings.availableBalance / warningBuffer;
            calculatedThresholds.safeWeekly = settings.availableBalance / safeBuffer;
            
            // Update threshold display
            document.getElementById('criticalWeeklyRate').textContent = `${calculatedThresholds.criticalWeekly.toFixed(1)} AEC/week`;
            document.getElementById('warningWeeklyRate').textContent = `${calculatedThresholds.warningWeekly.toFixed(1)} AEC/week`;
            document.getElementById('safeWeeklyRate').textContent = `${calculatedThresholds.safeWeekly.toFixed(1)} AEC/week`;
            
            // Calculate historical metrics
            const historicalByMonth = {};
            historicalData.forEach(row => {
                const startTime = row['Start Time'];
                if (startTime) {
                    const month = startTime.substring(0, 7);
                    const cost = parseFloat(row['Cost'] || 0);
                    historicalByMonth[month] = (historicalByMonth[month] || 0) + cost;
                }
            });

            const historicalMonthlyValues = Object.values(historicalByMonth);
            const historicalAvgMonthly = historicalMonthlyValues.length > 0 
                ? historicalMonthlyValues.reduce((a, b) => a + b, 0) / historicalMonthlyValues.length 
                : 0;

            const projectedMonthly = recentTotal * 4.33; // weeks to month conversion

            // Calculate runway
            const runwayWeeks = recentTotal > 0 ? settings.availableBalance / recentTotal : 999;
            const runwayMonths = runwayWeeks / 4.33;

            // Update stats
            document.getElementById('historicalAvg').textContent = historicalAvgMonthly.toFixed(1);
            document.getElementById('recentWeekly').textContent = recentTotal.toFixed(1);
            document.getElementById('projectedMonthly').textContent = projectedMonthly.toFixed(1);
            document.getElementById('runwayMonths').textContent = runwayWeeks.toFixed(1);

            // Add trend indicators
            const weeklyChange = ((projectedMonthly - historicalAvgMonthly) / historicalAvgMonthly) * 100;
            const weeklyTrendHTML = getTrendHTML(weeklyChange);
            document.getElementById('weeklyTrend').innerHTML = weeklyTrendHTML;
            document.getElementById('projectionTrend').innerHTML = weeklyTrendHTML;

            // Add burn rate status
            let burnRateStatus = '';
            if (recentTotal > calculatedThresholds.criticalWeekly) {
                burnRateStatus = '<div class="trend-indicator up" style="margin-top: 8px;">üî• Critical burn rate</div>';
            } else if (recentTotal > calculatedThresholds.warningWeekly) {
                burnRateStatus = '<div class="trend-indicator" style="margin-top: 8px; background: rgba(234, 88, 12, 0.15); color: var(--accent-warning);">‚ö†Ô∏è Elevated burn rate</div>';
            } else {
                burnRateStatus = '<div class="trend-indicator down" style="margin-top: 8px;">‚úì Sustainable rate</div>';
            }
            document.getElementById('weeklyTrend').innerHTML += burnRateStatus;

            // Calculate user metrics
            const historicalByUser = calculateUserMetrics(historicalData);
            const recentByUser = calculateUserMetrics(recentData);

            // Generate alerts with dynamic thresholds
            const alerts = generateAlerts(historicalByUser, recentByUser, historicalAvgMonthly, projectedMonthly);
            renderAlerts(alerts);

            // Render comparison tables
            renderUserComparison(historicalByUser, recentByUser);

            // Update purchase section
            const currentBalance = settings.availableBalance;
            document.getElementById('balanceWarning').textContent = `${currentBalance.toFixed(1)} AEC`;
            
            if (runwayMonths < 12) {
                const today = new Date();
                const depletionDate = new Date(today.getTime() + (runwayMonths * 30.44 * 24 * 60 * 60 * 1000));
                document.getElementById('depletionWarning').textContent = `~${depletionDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;
                
                // Add weeks display
                const weeksText = runwayWeeks < 1 
                    ? `(‚ö†Ô∏è Less than 1 week remaining!)` 
                    : `(~${runwayWeeks.toFixed(1)} weeks remaining)`;
                document.getElementById('depletionWeeks').innerHTML = weeksText;
                document.getElementById('depletionWeeks').style.color = runwayWeeks <= settings.leadTimeWeeks 
                    ? 'var(--accent-danger)' 
                    : runwayWeeks <= settings.leadTimeWeeks * 2 
                    ? 'var(--accent-warning)' 
                    : 'var(--text-secondary)';
            } else {
                document.getElementById('depletionWarning').textContent = '12+ months';
                document.getElementById('depletionWeeks').innerHTML = '(52+ weeks remaining)';
                document.getElementById('depletionWeeks').style.color = 'var(--accent-success)';
            }

            // Show purchase section if we're in warning or critical zone
            if (recentTotal > calculatedThresholds.warningWeekly || runwayWeeks <= settings.leadTimeWeeks * 2) {
                document.getElementById('purchaseSection').style.display = 'block';
            }

            // Generate pivot table
            generatePivotTable();
            
            // Generate monthly pie charts (only shows on 31st)
            generateMonthlyPieCharts();
        }

        function generatePivotTable() {
            // Get all months from historical data
            const monthlyData = {};
            const allMonths = new Set();
            
            historicalData.forEach(row => {
                const startTime = row['Start Time'];
                const user = row['Username'];
                const cost = parseFloat(row['Cost'] || 0);
                
                if (startTime && user) {
                    const month = startTime.substring(0, 7); // YYYY-MM
                    allMonths.add(month);
                    
                    if (!monthlyData[user]) {
                        monthlyData[user] = {};
                    }
                    monthlyData[user][month] = (monthlyData[user][month] || 0) + cost;
                }
            });

            // Sort months
            const sortedMonths = Array.from(allMonths).sort();
            
            // Generate month names
            const monthNames = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                return date.toLocaleDateString('en-US', { month: 'long' });
            });

            // Generate header
            const headerRow = document.getElementById('pivotTableHeader');
            headerRow.innerHTML = '<th>Username</th>' + 
                monthNames.map(name => `<th>${name}</th>`).join('') +
                '<th style="background: var(--bg-primary); font-weight: 700;">Total</th>';

            // Generate body
            const tbody = document.getElementById('pivotTableBody');
            const rows = [];
            const monthTotals = {};
            
            // Initialize month totals
            sortedMonths.forEach(month => {
                monthTotals[month] = 0;
            });

            // Sort users by total
            const userTotals = {};
            Object.keys(monthlyData).forEach(user => {
                userTotals[user] = Object.values(monthlyData[user]).reduce((a, b) => a + b, 0);
            });

            const sortedUsers = Object.keys(userTotals).sort((a, b) => userTotals[b] - userTotals[a]);

            // Generate rows
            sortedUsers.forEach(user => {
                let rowHTML = `<td>${user}</td>`;
                let userTotal = 0;
                
                sortedMonths.forEach(month => {
                    const value = monthlyData[user][month] || 0;
                    userTotal += value;
                    monthTotals[month] += value;
                    rowHTML += `<td>${value > 0 ? value.toFixed(1) : '0'}</td>`;
                });
                
                rowHTML += `<td style="font-weight: 600; background: var(--bg-secondary);">${userTotal.toFixed(1)}</td>`;
                rows.push(`<tr>${rowHTML}</tr>`);
            });

            // Add total row
            let totalRowHTML = '<td style="font-weight: 700;">Total</td>';
            let grandTotal = 0;
            sortedMonths.forEach(month => {
                const total = monthTotals[month];
                grandTotal += total;
                totalRowHTML += `<td style="font-weight: 600;">${total.toFixed(1)}</td>`;
            });
            totalRowHTML += `<td style="font-weight: 700; background: var(--bg-primary);">${grandTotal.toFixed(1)}</td>`;
            rows.push(`<tr class="total-row">${totalRowHTML}</tr>`);

            tbody.innerHTML = rows.join('');
        }

        function getTrendHTML(changePercent) {
            if (Math.abs(changePercent) < 10) {
                return `<span class="trend-indicator stable">‚âà ${Math.abs(changePercent).toFixed(0)}% stable</span>`;
            } else if (changePercent > 0) {
                return `<span class="trend-indicator up">‚Üë ${changePercent.toFixed(0)}% higher</span>`;
            } else {
                return `<span class="trend-indicator down">‚Üì ${Math.abs(changePercent).toFixed(0)}% lower</span>`;
            }
        }

        function calculateUserMetrics(data) {
            const userByMonth = {};
            
            data.forEach(row => {
                const user = row['Username'];
                const startTime = row['Start Time'];
                if (user && startTime) {
                    if (!userByMonth[user]) {
                        userByMonth[user] = {};
                    }
                    const month = startTime.substring(0, 7);
                    const cost = parseFloat(row['Cost'] || 0);
                    userByMonth[user][month] = (userByMonth[user][month] || 0) + cost;
                }
            });

            const userMetrics = {};
            Object.keys(userByMonth).forEach(user => {
                const monthlyValues = Object.values(userByMonth[user]);
                const total = monthlyValues.reduce((a, b) => a + b, 0);
                const avg = total / monthlyValues.length;
                const max = Math.max(...monthlyValues);
                
                userMetrics[user] = {
                    total,
                    avgMonthly: avg,
                    maxMonthly: max,
                    months: monthlyValues.length
                };
            });

            return userMetrics;
        }

        function generateAlerts(historicalByUser, recentByUser, historicalAvgMonthly, projectedMonthly) {
            const alerts = [];

            // Check each user in recent data
            Object.keys(recentByUser).forEach(user => {
                const recentWeekly = recentByUser[user].total;
                const recentProjected = recentWeekly * 4.33;
                
                const historical = historicalByUser[user];
                
                if (!historical) {
                    // New user - check against critical weekly threshold
                    if (recentWeekly >= calculatedThresholds.criticalWeekly) {
                        alerts.push({
                            user,
                            level: 'critical',
                            type: 'new-critical',
                            recentWeekly,
                            recentProjected,
                            historicalAvg: 0,
                            change: 999,
                            reason: `New user consuming ${recentWeekly.toFixed(1)} AEC/week (critical threshold: ${calculatedThresholds.criticalWeekly.toFixed(1)} AEC/week)`
                        });
                    } else if (recentWeekly >= calculatedThresholds.warningWeekly) {
                        alerts.push({
                            user,
                            level: 'high',
                            type: 'new-warning',
                            recentWeekly,
                            recentProjected,
                            historicalAvg: 0,
                            change: 999,
                            reason: `New user with elevated usage: ${recentWeekly.toFixed(1)} AEC/week`
                        });
                    }
                } else {
                    const historicalAvg = historical.avgMonthly;
                    const historicalWeekly = historicalAvg / 4.33;
                    const change = ((recentWeekly - historicalWeekly) / historicalWeekly) * 100;
                    
                    // Critical: User's weekly rate exceeds critical threshold
                    if (recentWeekly >= calculatedThresholds.criticalWeekly) {
                        alerts.push({
                            user,
                            level: 'critical',
                            type: 'burn-rate',
                            recentWeekly,
                            recentProjected,
                            historicalAvg,
                            change,
                            reason: `Weekly rate ${recentWeekly.toFixed(1)} AEC exceeds critical threshold ${calculatedThresholds.criticalWeekly.toFixed(1)} AEC. At this rate, balance depletes before new credits arrive.`
                        });
                    }
                    // Warning: User's weekly rate exceeds warning threshold
                    else if (recentWeekly >= calculatedThresholds.warningWeekly) {
                        alerts.push({
                            user,
                            level: 'high',
                            type: 'burn-rate',
                            recentWeekly,
                            recentProjected,
                            historicalAvg,
                            change,
                            reason: `Weekly rate ${recentWeekly.toFixed(1)} AEC exceeds warning threshold ${calculatedThresholds.warningWeekly.toFixed(1)} AEC`
                        });
                    }
                    // Acceleration alert: Usage increased significantly vs historical
                    else if (change >= settings.accelThreshold) {
                        alerts.push({
                            user,
                            level: 'accelerating',
                            type: 'acceleration',
                            recentWeekly,
                            recentProjected,
                            historicalAvg,
                            change,
                            reason: `Usage accelerating: ${change.toFixed(0)}% above historical average`
                        });
                    }
                }
            });

            return alerts.sort((a, b) => {
                const levelOrder = { critical: 0, high: 1, accelerating: 2 };
                return levelOrder[a.level] - levelOrder[b.level];
            });
        }

        function renderAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">‚úì No alerts. All users are within safe consumption rates.</p>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => {
                const description = alert.reason || 'Usage requires attention';

                return `
                    <div class="alert-card ${alert.level}">
                        <div class="alert-header">
                            <div class="alert-user">${alert.user}</div>
                            <div class="alert-badge ${alert.level}">${alert.level}</div>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; font-size: 0.8125rem;">${description}</p>
                        <div class="alert-details">
                            <div class="alert-metric">
                                <div class="alert-metric-label">Recent Week</div>
                                <div class="alert-metric-value" style="color: var(--accent-info);">${alert.recentWeekly.toFixed(1)} AEC</div>
                            </div>
                            <div class="alert-metric">
                                <div class="alert-metric-label">Projected/Month</div>
                                <div class="alert-metric-value" style="color: var(--accent-danger);">${alert.recentProjected.toFixed(1)} AEC</div>
                            </div>
                            <div class="alert-metric">
                                <div class="alert-metric-label">Historical Avg</div>
                                <div class="alert-metric-value" style="color: var(--accent-teal);">${alert.historicalAvg.toFixed(1)} AEC</div>
                            </div>
                            <div class="alert-metric">
                                <div class="alert-metric-label">Change</div>
                                <div class="alert-metric-value" style="color: ${alert.change > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'};">
                                    ${alert.change > 0 ? '+' : ''}${alert.change === 999 ? 'NEW' : alert.change.toFixed(0) + '%'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUserComparison(historicalByUser, recentByUser) {
            // Historical table
            const historicalUsers = Object.entries(historicalByUser)
                .sort((a, b) => b[1].avgMonthly - a[1].avgMonthly)
                .slice(0, 10);

            const historicalHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th style="text-align: right;">Avg/Month</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${historicalUsers.map(([user, metrics]) => `
                            <tr>
                                <td style="font-weight: 600;">${user}</td>
                                <td style="text-align: right; font-weight: 600; color: var(--accent-teal);">${metrics.avgMonthly.toFixed(1)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('historicalUserTable').innerHTML = historicalHTML;

            // Recent table with comparison
            const recentUsers = Object.entries(recentByUser)
                .map(([user, metrics]) => {
                    const historical = historicalByUser[user];
                    const projected = metrics.total * 4.33;
                    const change = historical 
                        ? ((projected - historical.avgMonthly) / historical.avgMonthly) * 100
                        : 999;
                    
                    return { user, projected, change };
                })
                .sort((a, b) => b.projected - a.projected)
                .slice(0, 10);

            const recentHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th style="text-align: right;">Recent Week</th>
                            <th style="text-align: right;">Projected/Month</th>
                            <th style="text-align: right;">vs Avg</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentUsers.map(({user, projected, change}) => {
                            const weeklyUsage = recentByUser[user].total;
                            return `
                            <tr>
                                <td style="font-weight: 600;">${user}</td>
                                <td style="text-align: right; font-weight: 600; color: var(--text-secondary);">${weeklyUsage.toFixed(1)}</td>
                                <td style="text-align: right; font-weight: 600; color: var(--accent-info);">${projected.toFixed(1)}</td>
                                <td style="text-align: right; font-weight: 600; color: ${change > 20 ? 'var(--accent-danger)' : change < -20 ? 'var(--accent-success)' : 'var(--text-secondary)'};">
                                    ${change === 999 ? 'NEW' : (change > 0 ? '+' : '') + change.toFixed(0) + '%'}
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('recentUserTable').innerHTML = recentHTML;
        }

        function requestPurchase() {
            const recentWeekly = parseFloat(document.getElementById('recentWeekly').textContent) || 0;
            const currentBalanceNum = parseFloat(document.getElementById('balanceWarning')?.textContent) || 0;
            
            // Simple calculation: current balance / weekly usage = weeks remaining
            const weeksRemaining = recentWeekly > 0 ? (currentBalanceNum / recentWeekly).toFixed(1) : 0;

            const subject = 'ANSYS AEC Purchase Request';
            const body = `Hi Ben and Dario,

We've been using ${recentWeekly.toFixed(1)} AECs per week which means we've got around ${weeksRemaining} weeks left with our current balance of ${currentBalanceNum.toFixed(1)} AEC.

Can you help in putting in another order of 5000 AECs so we don't have any periods of interruption?

Thanks so much!

Let me know if you need anything from me.

Best,
Natacha`;

            // Create Outlook web deeplink with To and CC
            const toEmails = 'BBennett@arete.com;dcontreras@arete.com';
            const ccEmails = 'tbaker@arete.com;mmarnon@arete.com';
            const outlookUrl = `https://outlook.office365.us/owa/arete.com/?path=/mail/action/compose&to=${encodeURIComponent(toEmails)}&cc=${encodeURIComponent(ccEmails)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open Outlook web
            window.open(outlookUrl, '_blank');
        }

        // Store monthly user data for email generation
        let monthlyUserData = {};

        // Generate monthly pie charts by user (shows previous month)
        function generateMonthlyPieCharts() {
            const today = new Date();
            
            // Get previous month
            const previousMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const targetMonth = previousMonth.getMonth();
            const targetYear = previousMonth.getFullYear();
            
            // Set the month name
            const monthName = previousMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('monthlyReportMonth').textContent = monthName;
            
            if (!historicalData || historicalData.length === 0) {
                document.getElementById('monthlyPieChartsContainer').innerHTML = 
                    '<p style="color: var(--text-secondary); text-align: center;">No data available. Please upload historical CSV data.</p>';
                return;
            }
            
            // Get previous month's data
            const monthlyData = historicalData.filter(row => {
                const rowDate = new Date(row.Date || row['Start Time']);
                return rowDate.getMonth() === targetMonth && rowDate.getFullYear() === targetYear;
            });
            
            if (monthlyData.length === 0) {
                document.getElementById('monthlyPieChartsContainer').innerHTML = 
                    '<p style="color: var(--text-secondary); text-align: center;">No usage data found for previous month.</p>';
                return;
            }
            
            // Group by user and software
            const userSoftwareHours = {};
            const userTotalAEC = {};
            
            monthlyData.forEach(row => {
                const user = row.Username || 'Unknown';
                const software = row.Product || row['Job Name'] || row.Software || 'Unknown';
                const hours = parseFloat(row.Hours) || 0;
                const cost = parseFloat(row.Cost) || 0;
                
                if (!userSoftwareHours[user]) {
                    userSoftwareHours[user] = {};
                    userTotalAEC[user] = 0;
                }
                
                if (!userSoftwareHours[user][software]) {
                    userSoftwareHours[user][software] = 0;
                }
                
                userSoftwareHours[user][software] += hours;
                userTotalAEC[user] += cost;
            });
            
            // Store for email function
            monthlyUserData = {
                month: monthName,
                users: {}
            };
            
            // Generate a pie chart for each user
            const container = document.getElementById('monthlyPieChartsContainer');
            container.innerHTML = '';
            
            // Color palette for software
            const colors = [
                '#005B7F', // Arete teal
                '#007aff', // Blue
                '#34c759', // Green
                '#ff9500', // Orange
                '#ff3b30', // Red
                '#af52de', // Purple
                '#00C7BE', // Cyan
                '#FF2D92', // Pink
                '#FFD60A', // Yellow
                '#BF5AF2'  // Light purple
            ];
            
            Object.keys(userSoftwareHours).sort().forEach((user, userIndex) => {
                const softwareData = userSoftwareHours[user];
                const totalHours = Object.values(softwareData).reduce((a, b) => a + b, 0);
                const totalAEC = userTotalAEC[user];
                
                // Store user data for email
                monthlyUserData.users[user] = {
                    totalHours: totalHours,
                    totalAEC: totalAEC,
                    software: softwareData
                };
                
                // Create card for this user
                const card = document.createElement('div');
                card.style.cssText = 'background: var(--bg-secondary); padding: 16px; border-radius: 12px; box-shadow: var(--shadow-sm); min-width: 280px; max-width: 320px; flex-shrink: 0;';
                
                // User header
                const header = document.createElement('div');
                header.style.cssText = 'margin-bottom: 12px;';
                header.innerHTML = `
                    <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">${user}</h3>
                    <p style="font-size: 0.7rem; color: var(--text-secondary);">Total: ${totalHours.toFixed(1)} hours | ${totalAEC.toFixed(1)} AEC</p>
                `;
                card.appendChild(header);
                
                // Create canvas for pie chart
                const canvas = document.createElement('canvas');
                canvas.id = `pieChart-${userIndex}`;
                canvas.style.cssText = 'max-height: 180px;';
                card.appendChild(canvas);
                
                // Legend
                const legend = document.createElement('div');
                legend.style.cssText = 'margin-top: 12px; display: flex; flex-wrap: wrap; gap: 4px 8px; font-size: 0.65rem;';
                
                Object.keys(softwareData).sort((a, b) => softwareData[b] - softwareData[a]).forEach((software, index) => {
                    const hours = softwareData[software];
                    const percentage = ((hours / totalHours) * 100).toFixed(0);
                    const color = colors[index % colors.length];
                    
                    const legendItem = document.createElement('div');
                    legendItem.style.cssText = 'display: flex; align-items: center; gap: 4px;';
                    legendItem.innerHTML = `
                        <div style="width: 8px; height: 8px; border-radius: 2px; background: ${color};"></div>
                        <span style="color: var(--text-secondary);">${software}: ${percentage}%</span>
                    `;
                    legend.appendChild(legendItem);
                });
                
                card.appendChild(legend);
                container.appendChild(card);
                
                // Draw pie chart
                const ctx = canvas.getContext('2d');
                const chartData = {
                    labels: Object.keys(softwareData),
                    datasets: [{
                        data: Object.values(softwareData),
                        backgroundColor: Object.keys(softwareData).map((_, i) => colors[i % colors.length]),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                };
                
                // Check if Chart.js is loaded
                if (typeof Chart !== 'undefined') {
                    new Chart(ctx, {
                        type: 'pie',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const percentage = ((value / totalHours) * 100).toFixed(1);
                                            return `${label}: ${value.toFixed(1)}h (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    // Fallback if Chart.js isn't loaded
                    canvas.remove();
                    const fallback = document.createElement('div');
                    fallback.style.cssText = 'padding: 20px; text-align: center; color: var(--text-secondary);';
                    fallback.textContent = 'Chart library not loaded';
                    card.appendChild(fallback);
                }
            });
        }

        // Email all users with their individual usage reports
        function emailAllUsers() {
            if (!monthlyUserData || !monthlyUserData.users || Object.keys(monthlyUserData.users).length === 0) {
                alert('No user data available. Please ensure historical data is loaded.');
                return;
            }
            
            const users = Object.keys(monthlyUserData.users).sort();
            
            // Open email queue modal
            showEmailQueueModal(users);
        }

        // Show modal to step through emails one at a time
        function showEmailQueueModal(users) {
            let currentIndex = 0;
            
            const modal = document.createElement('div');
            modal.id = 'emailQueueModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const updateModal = () => {
                const user = users[currentIndex];
                const userData = monthlyUserData.users[user];
                
                modal.innerHTML = `
                    <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; font-size: 1.25rem; color: var(--text-primary);">üìß Email Queue</h2>
                            <button onclick="document.getElementById('emailQueueModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">√ó</button>
                        </div>
                        
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0 0 8px 0; font-size: 0.875rem; color: var(--text-secondary);">
                                Email ${currentIndex + 1} of ${users.length}
                            </p>
                            <p style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">
                                üì§ ${user}@arete.com
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 0.8rem; color: var(--text-secondary);">
                                ${userData.totalHours.toFixed(1)} hours | ${userData.totalAEC.toFixed(1)} AEC
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="document.getElementById('emailQueueModal').remove()" 
                                style="padding: 10px 20px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.875rem; cursor: pointer;">
                                Cancel
                            </button>
                            <button id="openEmailBtn"
                                style="padding: 10px 20px; border: none; border-radius: 8px; background: var(--accent-teal); color: white; font-size: 0.875rem; font-weight: 600; cursor: pointer;">
                                üìß Open Email ${currentIndex < users.length - 1 ? '& Next' : '(Last)'}
                            </button>
                        </div>
                        
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="display: flex; gap: 4px;">
                                ${users.map((u, i) => `
                                    <div style="flex: 1; height: 4px; border-radius: 2px; background: ${i < currentIndex ? 'var(--accent-success)' : i === currentIndex ? 'var(--accent-teal)' : 'var(--bg-secondary)'};"></div>
                                `).join('')}
                            </div>
                            <p style="margin: 8px 0 0 0; font-size: 0.75rem; color: var(--text-secondary); text-align: center;">
                                ${currentIndex} sent ‚Ä¢ ${users.length - currentIndex} remaining
                            </p>
                        </div>
                    </div>
                `;
                
                // Add click handler for the open email button
                document.getElementById('openEmailBtn').addEventListener('click', () => {
                    const user = users[currentIndex];
                    const userData = monthlyUserData.users[user];
                    const subject = `Your ANSYS Usage Report - ${monthlyUserData.month}`;
                    const body = generateUserEmailContent(user, userData, monthlyUserData.month);
                    const toEmail = `${user}@arete.com`;
                    
                    // Create Outlook web deeplink
                    const outlookUrl = `https://outlook.office365.us/owa/arete.com/?path=/mail/action/compose&to=${encodeURIComponent(toEmail)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    
                    // Open in new tab
                    window.open(outlookUrl, '_blank');
                    
                    currentIndex++;
                    
                    if (currentIndex < users.length) {
                        updateModal();
                    } else {
                        modal.innerHTML = `
                            <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 16px;">‚úÖ</div>
                                <h2 style="margin: 0 0 8px 0; font-size: 1.25rem; color: var(--text-primary);">All Done!</h2>
                                <p style="margin: 0 0 20px 0; color: var(--text-secondary);">
                                    Opened ${users.length} email${users.length > 1 ? 's' : ''} in Outlook Web.
                                </p>
                                <button onclick="document.getElementById('emailQueueModal').remove()" 
                                    style="padding: 10px 24px; border: none; border-radius: 8px; background: var(--accent-teal); color: white; font-size: 0.875rem; font-weight: 600; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                        `;
                    }
                });
            };
            
            document.body.appendChild(modal);
            updateModal();
        }

        // Generate email content for a user
        function generateUserEmailContent(username, userData, month) {
            // Build software breakdown
            let softwareList = '';
            const sortedSoftware = Object.entries(userData.software)
                .sort((a, b) => b[1] - a[1]); // Sort by hours descending
            
            sortedSoftware.forEach(([software, hours]) => {
                const percentage = ((hours / userData.totalHours) * 100).toFixed(1);
                softwareList += `‚Ä¢ ${software}: ${hours.toFixed(1)} hours (${percentage}%)\n`;
            });
            
            const body = `Hello ${username},

This is your ANSYS usage summary for ${month}.

USAGE SUMMARY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Total Hours: ${userData.totalHours.toFixed(1)}
Total Cost: ${userData.totalAEC.toFixed(1)} AEC ($${userData.totalAEC.toFixed(2)} USD)

SOFTWARE BREAKDOWN
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${softwareList}
Please provide the breakdown and charge numbers for this usage.

Thanks!`;

            return body;
        }

        function exportToTeams() {
            const historicalAvg = parseFloat(document.getElementById('historicalAvg').textContent);
            const recentWeekly = parseFloat(document.getElementById('recentWeekly').textContent);
            const projectedMonthly = parseFloat(document.getElementById('projectedMonthly').textContent);
            const currentBalance = parseFloat(document.getElementById('balanceWarning').textContent);
            const runway = parseFloat(document.getElementById('runwayMonths').textContent);
            const runwayWeeks = runway * 4.33;
            const alertCount = document.querySelectorAll('.alert-card').length;

            // Determine status emoji
            let statusEmoji = '‚úÖ';
            let statusText = 'Good';
            if (recentWeekly > calculatedThresholds.criticalWeekly) {
                statusEmoji = 'üî¥';
                statusText = 'Critical';
            } else if (recentWeekly > calculatedThresholds.warningWeekly) {
                statusEmoji = 'üü°';
                statusText = 'Warning';
            } else if (runwayWeeks <= settings.leadTimeWeeks * 2) {
                statusEmoji = 'üü†';
                statusText = 'Monitor';
            }

            // Get top 3 users from alerts or recent usage
            const alerts = Array.from(document.querySelectorAll('.alert-card')).slice(0, 3);
            let topUsersText = '';
            if (alerts.length > 0) {
                topUsersText = '\n\nHIGH USAGE USERS:\n';
                alerts.forEach(alert => {
                    const userName = alert.querySelector('.alert-user').textContent;
                    const level = alert.querySelector('.alert-badge').textContent;
                    topUsersText += `  ‚Ä¢ ${userName} (${level})\n`;
                });
            }

            const message = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n` +
                `ANSYS AEC USAGE STATUS UPDATE ${statusEmoji}\n` +
                `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
                `OVERALL STATUS: ${statusText}\n\n` +
                `CURRENT METRICS:\n` +
                `  ‚Ä¢ Current Balance: ${currentBalance.toFixed(1)} AEC\n` +
                `  ‚Ä¢ Burn Rate: ${recentWeekly.toFixed(1)} AEC/week\n` +
                `  ‚Ä¢ Projected Monthly: ${projectedMonthly.toFixed(1)} AEC/month\n` +
                `  ‚Ä¢ Historical Average: ${historicalAvg.toFixed(1)} AEC/month\n` +
                `  ‚Ä¢ Trend: ${projectedMonthly > historicalAvg ? '‚Üë' : '‚Üì'} ${Math.abs(((projectedMonthly - historicalAvg) / historicalAvg) * 100).toFixed(0)}%\n\n` +
                `RUNWAY:\n` +
                `  ‚Ä¢ Time Remaining: ${runwayWeeks.toFixed(1)} weeks (${runway.toFixed(1)} months)\n` +
                `  ‚Ä¢ Projected Depletion: ${document.getElementById('depletionWarning').textContent}\n\n` +
                `THRESHOLDS:\n` +
                `  ‚Ä¢ Critical Rate: ${calculatedThresholds.criticalWeekly.toFixed(1)} AEC/week\n` +
                `  ‚Ä¢ Warning Rate: ${calculatedThresholds.warningWeekly.toFixed(1)} AEC/week\n` +
                `  ‚Ä¢ Safe Rate: ${calculatedThresholds.safeWeekly.toFixed(1)} AEC/week${topUsersText}\n\n` +
                `${alertCount > 0 ? `‚ö†Ô∏è  ${alertCount} user(s) flagged for high usage\n\n` : ''}` +
                `Updated: ${new Date().toLocaleString()}\n` +
                `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

            // Copy to clipboard
            navigator.clipboard.writeText(message).then(() => {
                alert('‚úÖ Status update copied to clipboard!\n\nYou can now paste this into your Teams channel.');
            }).catch(() => {
                // Fallback if clipboard fails
                const textarea = document.createElement('textarea');
                textarea.value = message;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úÖ Status update copied to clipboard!\n\nYou can now paste this into your Teams channel.');
            });
        }

        // Export Quote to PDF with Fillable Fields
        function exportQuoteToPDF() {
            const { jsPDF } = window.jspdf;
            
            // Get current date
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
            
            // Collect software usage data
            const rows = document.querySelectorAll('.software-row');
            let usageData = [];
            let totalCredits = 0;
            
            rows.forEach(row => {
                const software = row.querySelector('.software-select').value;
                const softwareName = row.querySelector('.software-select').selectedOptions[0]?.text;
                const hours = parseFloat(row.querySelector('.hours-input').value) || 0;
                const weeks = parseFloat(row.querySelector('.weeks-input').value) || 1;
                
                if (software && hours > 0) {
                    const rate = softwareRates[software];
                    const credits = rate * hours * weeks;
                    totalCredits += credits;
                    
                    usageData.push({
                        software: softwareName,
                        rate: rate,
                        hours: hours,
                        weeks: weeks,
                        credits: credits
                    });
                }
            });
            
            if (usageData.length === 0) {
                alert('Please add at least one software with hours to generate a quote.');
                return;
            }
            
            const quoteNumber = `AEC-${Date.now().toString().slice(-6)}`;
            
            // Create PDF
            const doc = new jsPDF();
            
            let yPos = 20;
            
            // Company name - top left (Aret√© with accent)
            doc.setFontSize(28);
            doc.setTextColor(0, 91, 127); // Arete teal
            doc.setFont('helvetica', 'bold');
            doc.text('Aret\u00E9', 20, yPos); // √© = \u00E9
            
            // "ANSYS AEC Quote" - top right
            doc.setFontSize(20);
            doc.setTextColor(150, 150, 150);
            doc.setFont('helvetica', 'normal');
            doc.text('ANSYS AEC Quote', 190, yPos, { align: 'right' });
            
            yPos += 8;
            
            // Company address
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.text('9301 Corbin Ave, Suite 2000', 20, yPos);
            yPos += 5;
            doc.text('Northridge, CA 91324', 20, yPos);
            
            yPos += 15;
            
            // Quote details on right side (only Quote # and Quote Date now)
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'bold');
            doc.text('Quote #', 140, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);
            doc.text(quoteNumber, 190, yPos, { align: 'right' });
            
            yPos += 7;
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'bold');
            doc.text('Quote Date', 140, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);
            doc.text(dateStr, 190, yPos, { align: 'right' });
            
            // Rate explanation text on left - two separate lines
            yPos -= 7;
            doc.setFontSize(9);
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'normal');
            doc.text('Costs are calculated using the official ANSYS Elastic Credit (AEC) rate table.', 20, yPos);
            yPos += 5;
            doc.text('Exchange rate: 1 AEC = $1.00 USD', 20, yPos);
            
            yPos += 20;
            
            // Table with borders
            const tableTop = yPos;
            const colWidths = [25, 75, 25, 25, 30]; // QTY, Description, # Hours, # Weeks, Amount
            const tableWidth = colWidths.reduce((a, b) => a + b, 0);
            const rowHeight = 10;
            const startX = 20;
            
            // Table header background
            doc.setFillColor(245, 245, 245);
            doc.rect(startX, yPos - 5, tableWidth, rowHeight, 'F');
            
            // Table header text
            doc.setFontSize(9);
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'bold');
            
            let xPos = startX + 2;
            doc.text('QTY', xPos, yPos + 2);
            xPos += colWidths[0];
            doc.text('DESCRIPTION', xPos, yPos + 2);
            xPos += colWidths[1];
            doc.text('# HOURS', xPos, yPos + 2);
            xPos += colWidths[2];
            doc.text('# WEEKS', xPos, yPos + 2);
            xPos += colWidths[3];
            doc.text('AMOUNT', xPos, yPos + 2);
            
            // Draw header borders
            doc.setDrawColor(180, 180, 180);
            doc.setLineWidth(0.5);
            
            // Header bottom line
            doc.line(startX, yPos + 5, startX + tableWidth, yPos + 5);
            // Header top line
            doc.line(startX, yPos - 5, startX + tableWidth, yPos - 5);
            // Header vertical lines
            let vLineX = startX;
            for (let i = 0; i <= colWidths.length; i++) {
                doc.line(vLineX, yPos - 5, vLineX, yPos + 5);
                vLineX += colWidths[i] || 0;
            }
            
            yPos += 5;
            
            // Table rows
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            
            usageData.forEach((item, index) => {
                const rowTop = yPos;
                yPos += rowHeight;
                
                doc.setTextColor(50, 50, 50);
                
                xPos = startX + 2;
                doc.text(`${item.hours * item.weeks}`, xPos, rowTop + 7);
                xPos += colWidths[0];
                doc.text(`${item.software}`, xPos, rowTop + 7);
                xPos += colWidths[1];
                doc.text(`${item.hours}`, xPos, rowTop + 7);
                xPos += colWidths[2];
                doc.text(`${item.weeks}`, xPos, rowTop + 7);
                xPos += colWidths[3];
                doc.text(`$${item.credits.toFixed(2)}`, xPos, rowTop + 7);
                
                // Row bottom line
                doc.line(startX, yPos, startX + tableWidth, yPos);
                
                // Row vertical lines
                vLineX = startX;
                for (let i = 0; i <= colWidths.length; i++) {
                    doc.line(vLineX, rowTop, vLineX, yPos);
                    vLineX += colWidths[i] || 0;
                }
            });
            
            // Draw line before subtotal
            yPos += 10;
            doc.setDrawColor(200, 200, 200);
            doc.line(startX + colWidths[0] + colWidths[1] + colWidths[2], yPos, startX + tableWidth, yPos);
            
            yPos += 10;
            
            // Subtotal
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Subtotal', startX + colWidths[0] + colWidths[1] + colWidths[2] + 5, yPos);
            doc.setTextColor(50, 50, 50);
            doc.text(`$${totalCredits.toFixed(2)}`, startX + tableWidth, yPos, { align: 'right' });
            
            yPos += 15;
            
            // Total
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(50, 50, 50);
            doc.text('TOTAL', startX + colWidths[0] + colWidths[1] + colWidths[2] + 5, yPos);
            doc.setFontSize(14);
            doc.text(`$${totalCredits.toFixed(2)}`, startX + tableWidth, yPos, { align: 'right' });
            
            // Quote created by section (no date line)
            yPos += 30;
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'bold');
            doc.text('Quote created by:', 20, yPos);
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(0.3);
            doc.line(20, yPos, 100, yPos);
            
            // Quote validity at bottom
            yPos = 270;
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.text('Quote valid for 180 days from date of issue.', 105, yPos, { align: 'center' });
            
            // Save PDF
            const filename = `Arete_ANSYS_Quote_${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}.pdf`;
            doc.save(filename);
        }
    </script>
</body>
</html>
